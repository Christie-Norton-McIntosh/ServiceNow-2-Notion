!function(){"use strict";window.BUILD_VERSION="10.0.34",function(){const e="undefined"!=typeof window&&window.BUILD_VERSION||"9.0.0",t="ServiceNow",n="#0066cc",o="#004499",a={databaseId:"24ca89fe-dba5-806f-91a6-e831a6efe344",databaseName:"ServiceNow-2-Notion (API DB)",proxyUrl:"http://127.0.0.1:3004",useMartian:!0,directSDKImages:!0,debugMode:!0,showAllDatabases:!1,enableDuplicateDetection:!0,enableAdvancedContent:!0},r={version:"#zDocsContent > header > ul > li.zDocsTopicPageCluster > div > div > button > div > div > div",updated:"#zDocsContent > header > ul > li.zDocsTopicPageDate.css-cinqea > span",breadcrumb:"#zDocsTopicPage > div.zDocsTopicPageTopicContainer > div.zDocsTopicPageBreadcrumbsContainer > div",Catagory:"#zDocsTopicPage > div.zDocsTopicPageTopicContainer > div.zDocsTopicPageBreadcrumbsContainer > div > span:nth-child(3) > a",category:"#zDocsTopicPage > div.zDocsTopicPageTopicContainer > div.zDocsTopicPageBreadcrumbsContainer > div > span:nth-child(3) > a",Section:"#zDocsTopicPage > div.zDocsTopicPageTopicContainer > div.zDocsTopicPageBreadcrumbsContainer > div > span:nth-child(4) > a",section:"#zDocsTopicPage > div.zDocsTopicPageTopicContainer > div.zDocsTopicPageBreadcrumbsContainer > div > span:nth-child(4) > a",title:"#zDocsContent > header > h1"};function i(){if("undefined"==typeof GM_getValue)return a;let e={...a,...GM_getValue("notionConfig",{})};return e.databaseId||(e.databaseId=a.databaseId,e.databaseName=a.databaseName),e}function s(){return Object.assign({},r,"undefined"!=typeof window&&window.W2N_CUSTOM_SELECTORS||{})}function c(...e){i().debugMode&&console.log(`[${t}]`,...e)}async function l(){c("üîß Initializing configuration...");(function(){if("undefined"==typeof GM_getValue||"undefined"==typeof GM_setValue)return!1;try{const e=GM_getValue("w2n_config");if(!e)return!1;let t=e;if("string"==typeof e)try{t=JSON.parse(e)}catch(n){t={legacyValue:e}}const n={...GM_getValue("notionConfig",{}),...t};GM_setValue("notionConfig",n),c("üîÅ Migrated legacy w2n_config to notionConfig:",n);try{GM_setValue("w2n_config",null)}catch(e){}return!0}catch(e){return c("Migration check failed:",e),!1}})()&&c("‚úÖ Configuration migration completed");const t=i();return c("‚úÖ Configuration initialized:",{version:e,databaseId:t.databaseId?t.databaseId.slice(-8):"none",proxyUrl:t.proxyUrl,debugMode:t.debugMode}),t}const d="w2n-saving-progress",u="w2n-progress-";let p=!1;function g(e,t={},n=""){const o=document.createElement(e);return Object.entries(t).forEach(([e,t])=>{"class"===e?o.className=t:"style"===e?o.style.cssText=t:o.setAttribute(e,t)}),n&&(o.textContent=n),o}let m={opened:!1,onClose:null,retryCallback:null,autoCloseMs:null},f=null;function h(e){f=e}function b(){!function(){if(p)return;p=!0;const e=document.createElement("style");e.textContent=`\n    .${u}spinner {\n      display: block;\n      width: 40px;\n      height: 40px;\n      border: 4px solid #e5e7eb;\n      border-top-color: #3b82f6;\n      border-radius: 50%;\n      animation: ${u}spin 1s linear infinite;\n      margin: 20px auto;\n    }\n\n    @keyframes ${u}spin {\n      to { transform: rotate(360deg); }\n    }\n\n    .${u}bar {\n      display: block;\n      width: 100%;\n      height: 8px;\n      background: #e5e7eb;\n      border-radius: 4px;\n      overflow: hidden;\n      margin: 20px 0;\n    }\n\n    .${u}bar-fill {\n      display: block;\n      height: 100%;\n      background: linear-gradient(90deg, #3b82f6, #10b981);\n      transition: width 0.3s ease;\n      border-radius: 4px;\n    }\n\n    .${u}steps {\n      list-style: none;\n      padding: 0;\n      margin: 15px 0;\n      max-height: 150px;\n      overflow-y: auto;\n      font-size: 13px;\n      color: #6b7280;\n    }\n\n    .${u}steps li {\n      padding: 4px 0;\n    }\n\n    .${u}actions {\n      display: flex;\n      gap: 10px;\n      margin-top: 20px;\n      justify-content: flex-end;\n      flex-wrap: wrap;\n    }\n\n    .${u}view,\n    .${u}retry,\n    .${u}close,\n    .${u}config {\n      padding: 8px 16px;\n      border-radius: 4px;\n      border: none;\n      cursor: pointer;\n      font-size: 14px;\n      text-decoration: none;\n    }\n\n    .${u}view {\n      background: #10b981;\n      color: white;\n    }\n\n    .${u}retry {\n      background: #f59e0b;\n      color: white;\n    }\n\n    .${u}close {\n      background: #6b7280;\n      color: white;\n    }\n\n    .${u}success-check {\n      width: 60px;\n      height: 60px;\n      border-radius: 50%;\n      background: #10b981;\n      color: white;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-size: 36px;\n      font-weight: bold;\n      margin: 20px auto;\n      animation: ${u}scale-in 0.3s ease;\n    }\n\n    @keyframes ${u}scale-in {\n      from { transform: scale(0); }\n      to { transform: scale(1); }\n    }\n\n    .${u}title {\n      margin: 0 0 10px 0;\n      font-size: 20px;\n      font-weight: 600;\n      color: #1f2937;\n    }\n\n    .${u}message {\n      margin: 10px 0;\n      font-size: 14px;\n      color: #4b5563;\n      min-height: 20px;\n    }\n  `,document.head.appendChild(e)}();const e=g("div",{id:d,style:"position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;"}),t=g("div",{class:u+"panel",style:"background:white;border-radius:8px;padding:20px;min-width:400px;max-width:90vw;box-shadow:0 10px 30px rgba(0,0,0,0.3);",role:"dialog","aria-labelledby":u+"title"}),n=g("div",{class:u+"preview","aria-hidden":"true",style:"display:flex;align-items:center;gap:10px;margin:10px 0;padding:10px;border:1px solid #e5e7eb;border-radius:6px;background:#f9fafb;min-height:60px;"}),o=g("h2",{id:u+"title",class:u+"title"},"Saving to Notion‚Ä¶"),a=g("div",{class:u+"message","aria-live":"polite"}),r=g("div",{class:u+"spinner","aria-hidden":"true"}),i=g("div",{class:u+"bar","aria-hidden":"true"}),s=g("div",{class:u+"bar-fill"});i.appendChild(s);const c=g("ul",{class:u+"steps","aria-hidden":"true"}),l=g("div",{class:u+"actions"}),m=g("a",{class:u+"view",target:"_blank",rel:"noopener noreferrer",href:"#",hidden:"true"},"View in Notion"),h=g("button",{class:u+"retry",type:"button",hidden:"true"},"Retry"),b=g("button",{class:u+"close",type:"button"},"Close"),x=g("button",{class:u+"config",type:"button",style:"padding: 8px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 8px;"},"Configure Property Mapping");l.appendChild(m),l.appendChild(h),l.appendChild(b),l.appendChild(x);try{"undefined"!=typeof window&&window.debug&&window.debug("createOverlay initialized",{hasConfigButton:!!x,actionsCount:l.children.length})}catch(e){}return t.appendChild(n),t.appendChild(o),t.appendChild(a),t.appendChild(r),t.appendChild(i),t.appendChild(c),t.appendChild(l),e.appendChild(t),b.addEventListener("click",()=>y.close()),h.addEventListener("click",()=>y._invokeRetry()),x.addEventListener("click",()=>{"undefined"!=typeof window&&window.debug&&window.debug("Configure Property Mapping button clicked"),y.close(),f&&f()}),document.documentElement.appendChild(e),e}const y={start(e={}){const t=b();try{"undefined"!=typeof window&&window.debug&&window.debug("overlayModule.start",{hasConfig:!!t.querySelector("."+u+"config")})}catch(e){}m.opened=!0,m.onClose="function"==typeof e.onClose?e.onClose:null,m.retryCallback=null,m.autoCloseMs=e.autoCloseMs||null;const n=t.querySelector("."+u+"title"),o=t.querySelector("."+u+"message"),a=t.querySelector("."+u+"spinner"),r=t.querySelector("."+u+"bar"),i=t.querySelector("."+u+"steps"),s=t.querySelector("."+u+"view"),c=t.querySelector("."+u+"retry");return s.hidden=!0,s.removeAttribute("href"),c.hidden=!0,a.style.display="",r.style.display="none",i.style.display="none",n.textContent=e.title||"Saving to Notion‚Ä¶",o.textContent=e.message||"",e.preview&&y.setPreview(e.preview),t.style.display="flex",setTimeout(()=>{const e=t.querySelector("button");e&&e.focus()},80),y},setMessage(e){const t=document.getElementById(d);if(!t)return;const n=t.querySelector("."+u+"message");n&&(n.textContent=e||"")},setStep(e){const t=document.getElementById(d);if(!t)return;const n=t.querySelector("."+u+"steps");if(!n)return;n.style.display="";const o=g("li",{},e);n.appendChild(o),n.scrollTop=n.scrollHeight},setProgress(e){const t=document.getElementById(d);if(!t)return;const n=t.querySelector("."+u+"spinner"),o=t.querySelector("."+u+"bar"),a=t.querySelector("."+u+"bar-fill");if(!a)return;const r=Math.max(0,Math.min(100,Number(e)||0));n.style.display="none",o.style.display="",a.style.width=r+"%"},setPreview({icon:e,cover:t}={}){const n=document.getElementById(d),o=n||b();try{"undefined"!=typeof window&&window.debug&&window.debug("setPreview",{existingOverlay:!!n,hasConfig:!!o.querySelector("."+u+"config")})}catch(e){}const a=o.querySelector("."+u+"preview");if(a.innerHTML="",e){const t=g("div",{class:u+"icon",style:"font-size:32px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;flex-shrink:0;"},e);a.appendChild(t)}if(t)try{const e=g("img",{src:t,alt:"cover preview",style:"width:80px;height:60px;object-fit:cover;border-radius:4px;flex-shrink:0;"});a.appendChild(e)}catch(e){}},done({success:e=!0,pageUrl:t=null,autoCloseMs:n=null}={}){const o=document.getElementById(d);if(!o)return;const a=o.querySelector("."+u+"spinner"),r=o.querySelector("."+u+"bar"),i=o.querySelector("."+u+"steps"),s=o.querySelector("."+u+"view");a.style.display="none",r.style.display="none",i&&(i.style.display="none");let c=o.querySelector("."+u+"success-check");if(!c){c=g("div",{class:u+"success-check"},"‚úì");const e=o.querySelector("."+u+"panel");e.insertBefore(c,e.querySelector("."+u+"message").nextSibling)}t&&(s.hidden=!1,s.href=t,s.textContent="View in Notion");const l=n||m.autoCloseMs;l&&Number(l)>0&&setTimeout(()=>y.close(),Number(l))},error({message:e="An error occurred",retryCallback:t=null}={}){const n=document.getElementById(d);if(!n)return;const o=n.querySelector("."+u+"message");o&&(o.textContent=e||"");const a=n.querySelector("."+u+"retry");"function"==typeof t?(a.hidden=!1,m.retryCallback=t):(a.hidden=!0,m.retryCallback=null)},close(){const e=document.getElementById(d);if(e&&(e.remove(),m.opened=!1,"function"==typeof m.onClose))try{m.onClose()}catch(e){try{"undefined"!=typeof window&&window.debug&&window.debug("W2NSavingProgress onClose handler threw",e)}catch(e){}}},_invokeRetry(){if("function"==typeof m.retryCallback)try{m.retryCallback()}catch(e){try{"undefined"!=typeof window&&window.debug&&window.debug("W2NSavingProgress retry callback error",e)}catch(e){}}}};var x=Object.freeze({__proto__:null,overlayModule:y,setPropertyMappingModalInjector:h});function w(){if(document.getElementById("w2n-advanced-settings-modal"))return;const e=i(),t=document.createElement("div");t.id="w2n-advanced-settings-modal",t.style.cssText="\n    position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; z-index:11000;\n    background: rgba(0,0,0,0.4);\n  ",t.innerHTML=`\n    <div style="width:480px; max-width:95%; background:white; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.2); overflow:hidden;">\n      <div style="padding:16px 20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">\n        <strong>‚öôÔ∏è Advanced Settings</strong>\n        <button id="w2n-close-advanced-settings" style="background:none;border:none;font-size:18px;cursor:pointer">√ó</button>\n      </div>\n      <div style="padding:20px;">\n        <div style="margin-bottom:16px;">\n          <label style="display: flex; align-items: center; margin-bottom: 12px; font-size: 14px; cursor: pointer;">\n            <input type="checkbox" id="w2n-modal-use-martian" ${e.useMartian?"checked":""} style="margin-right: 10px; transform: scale(1.1);">\n            <span style="flex:1;">Use Martian conversion</span>\n          </label>\n          <div style="font-size: 12px; color: #6b7280; margin-left: 24px; margin-top: -8px;">\n            Enhanced content processing for better Notion formatting\n          </div>\n        </div>\n        \n        <div style="margin-bottom:16px;">\n          <label style="display: flex; align-items: center; margin-bottom: 12px; font-size: 14px; cursor: pointer;">\n            <input type="checkbox" id="w2n-modal-direct-images" ${e.directSDKImages?"checked":""} style="margin-right: 10px; transform: scale(1.1);">\n            <span style="flex:1;">Direct SDK image processing</span>\n          </label>\n          <div style="font-size: 12px; color: #6b7280; margin-left: 24px; margin-top: -8px;">\n            Process images directly through Notion API (faster uploads)\n          </div>\n        </div>\n        \n        <div style="margin-bottom:16px;">\n          <label style="display: flex; align-items: center; margin-bottom: 12px; font-size: 14px; cursor: pointer;">\n            <input type="checkbox" id="w2n-modal-enable-debugging" style="margin-right: 10px; transform: scale(1.1);">\n            <span style="flex:1;">Enable debugging (client & server)</span>\n          </label>\n          <div style="font-size: 12px; color: #6b7280; margin-left: 24px; margin-top: -8px;">\n            Enable detailed logging in both client (console) and server (proxy logs)\n          </div>\n        </div>\n        \n  <div style="margin-bottom:20px;">\n          <label style="display: flex; align-items: center; margin-bottom: 12px; font-size: 14px; cursor: pointer;">\n            <input type="checkbox" id="w2n-modal-duplicate-detect" ${e.enableDuplicateDetection?"checked":""} style="margin-right: 10px; transform: scale(1.1);">\n            <span style="flex:1;">Search for duplicates</span>\n          </label>\n          <div style="font-size: 12px; color: #6b7280; margin-left: 24px; margin-top: -8px;">\n            Check for existing pages with same title before creating new ones\n          </div>\n        </div>\n        \n        <div style="display:flex; gap:10px; padding-top:16px; border-top:1px solid #eee;">\n          <button id="w2n-save-advanced-settings" style="flex:1;padding:10px;border-radius:6px;background:#10b981;color:white;border:none;cursor:pointer;font-size:14px;">\n            Save Settings\n          </button>\n          <button id="w2n-cancel-advanced-settings" style="flex:1;padding:10px;border-radius:6px;background:#6b7280;color:white;border:none;cursor:pointer;font-size:14px;">\n            Cancel\n          </button>\n        </div>\n      </div>\n    </div>\n  `,document.body.appendChild(t),function(e){const t=e.querySelector("#w2n-close-advanced-settings"),n=e.querySelector("#w2n-save-advanced-settings"),o=e.querySelector("#w2n-cancel-advanced-settings");function a(){e.parentNode&&e.parentNode.removeChild(e)}t.onclick=a,o.onclick=a,e.onclick=t=>{t.target===e&&a()},(async()=>{const t=e.querySelector("#w2n-modal-enable-debugging");if(!t)return;const n=i();let o=!1;try{const e=await fetch("/api/logging");if(e.ok){const n=await e.json();o=!(!n||!n.verbose),n&&void 0!==n.extraDebug&&(t.checked=!!n.extraDebug)}}catch(e){c("Could not fetch /api/logging for combined checkbox:",e)}void 0===t.checked&&(t.checked=n.debugMode&&o),c("Populated combined debugging checkbox:",t.checked)})(),n.onclick=()=>{const t=e.querySelector("#w2n-modal-use-martian").checked,n=e.querySelector("#w2n-modal-direct-images").checked,o=e.querySelector("#w2n-modal-duplicate-detect").checked,r=e.querySelector("#w2n-modal-enable-debugging").checked,s=i();s.useMartian=t,s.directSDKImages=n,s.debugMode=r,s.enableDuplicateDetection=o;try{"undefined"!=typeof GM_setValue&&GM_setValue("notionConfig",s),"undefined"!=typeof GM_notification&&GM_notification({text:"Settings saved successfully",title:"ServiceNow",timeout:2e3}),c("‚öôÔ∏è Settings saved:",s);try{"function"==typeof window.updateUIFromConfig&&window.updateUIFromConfig()}catch(e){c("Failed updating UI after settings save:",e)}(async()=>{try{await fetch("/api/logging",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({verbose:!!r,extraDebug:!!r})}),c("Updated server logging flags:",r)}catch(e){c("Failed to update server logging setting:",e)}})()}catch(e){"undefined"!=typeof GM_notification&&GM_notification({text:"Failed to save settings",title:"ServiceNow",timeout:2e3}),c("Failed to save settings:",e)}a()}}(t)}async function v(e,t,n=null){return new Promise((o,a)=>{const r=i().proxyUrl+t;if(n&&(n.content||n.contentHtml)){const e=n.content||n.contentHtml;console.log("üîç apiCall - HTML length before stringify:",e.length);const t=(e.match(/<section[^>]*id="predictive-intelligence-for-incident__section_/g)||[]).length;console.log("üîç apiCall - Sections before stringify:",t)}if("undefined"==typeof GM_xmlhttpRequest)return void async function(e,t,n=null){try{const o=new AbortController,a=setTimeout(()=>o.abort(),3e5),r={method:e,headers:{"Content-Type":"application/json"},signal:o.signal};n&&(r.body=JSON.stringify(n));const i=await fetch(t,r);if(clearTimeout(a),!i.ok)throw new Error(`HTTP error! status: ${i.status}`);return await i.json()}catch(e){if("AbortError"===e.name)throw c("‚ùå Fallback API call timed out after 5 minutes"),new Error("Request timed out after 5 minutes. The page may be too large or processing is taking too long. Try a smaller page or contact support.");throw c("‚ùå Fallback API call failed:",e),e}}(e,r,n).then(o).catch(a);const s=n?JSON.stringify(n):void 0;if(s&&n&&(n.content||n.contentHtml)){console.log("üîç apiCall - Stringified data length:",s.length);const e=(s.match(/predictive-intelligence-for-incident__section_/g)||[]).length;console.log("üîç apiCall - Sections in stringified data:",e);const t=(s.length/1048576).toFixed(2);console.log(`üì¶ apiCall - Payload size: ${t} MB`),s.length>10485760&&console.warn(`‚ö†Ô∏è Large payload detected (${t} MB) - this may cause timeout or memory issues`)}console.log(`üåê apiCall - Sending ${e} request to ${r} with timeout: 300s`),GM_xmlhttpRequest({method:e,url:r,headers:{"Content-Type":"application/json"},data:s,timeout:3e5,onload:function(e){try{const t=JSON.parse(e.responseText);o(t)}catch(t){c("‚ùå Failed to parse API response:",e.responseText),o({success:!1,error:"Invalid API response"})}},onerror:function(e){c("‚ùå API call failed:",e),console.error("[NETWORK-ERROR] Full error object:",JSON.stringify(e,null,2)),console.error("[NETWORK-ERROR] Error keys:",Object.keys(e)),console.error("[NETWORK-ERROR] Error type:",typeof e),console.error("[NETWORK-ERROR] Status code:",e.status),console.error("[NETWORK-ERROR] URL attempted:",r);let t="Network error";e&&(408===e.status?t="Request timeout - Server did not respond in time. The page may be too large or the proxy server may be busy.":0===e.status?t="Cannot connect to proxy server. Please ensure:\n1. The proxy server is running (npm start in server/)\n2. Tampermonkey has permission to access localhost\n3. No firewall is blocking the connection":"string"==typeof e?t=e:e.error?t=e.error:e.statusText?t=e.statusText:e.message&&(t=e.message)),a(new Error(`API call failed: ${t}`))},ontimeout:function(){c("‚ùå API call timed out after 5 minutes"),a(new Error("Request timed out after 5 minutes. The page may be too large or processing is taking too long. Try a smaller page or contact support."))}})})}async function S(e){c(`üìä Fetching database schema for: ${e}`);try{const t=await v("GET",`/api/databases/${e}`);if(t&&t.error)throw c(`‚ùå Proxy returned error fetching database schema: ${t.error}`),new Error(t.error);if(t&&t.database)return c("‚úÖ Database schema retrieved:",t.database.properties?Object.keys(t.database.properties):"No properties"),t.database;if(t&&t.success&&t.data){const n=t.data,o={id:n.id||e,title:n.title||null,properties:n.properties||n.schema||{}};return c("‚úÖ Database schema retrieved (canonical):",o.properties?Object.keys(o.properties):"No properties"),o}if(t&&t.success&&(t.properties||t.schema)){const n=t.properties||t.schema||{},o={id:t.id||e,title:t.title||null,properties:n};return c("‚úÖ Database schema retrieved (normalized):",n?Object.keys(n):"No properties"),o}throw new Error("Invalid database schema response")}catch(e){throw c("‚ùå Failed to fetch database schema:",e),e}}async function T(){c("üè• Checking proxy server health");try{const e=await v("GET","/api/health");if(e){if("ok"===e.status)return c("‚úÖ Proxy server is healthy (legacy shape)"),{healthy:!0,...e};if(e.success&&e.data&&"ok"===e.data.status)return c("‚úÖ Proxy server is healthy (canonical shape)"),{healthy:!0,...e.data,_meta:e.meta||{}}}return{healthy:!1,error:"Invalid health response"}}catch(e){return c("‚ùå Proxy health check failed:",e),{healthy:!1,error:e.message}}}const E=["abstract","geometric","background","pattern","gradient","texture"];function C(){if(document.getElementById("w2n-icon-cover-modal"))return;const e=document.createElement("div");e.id="w2n-icon-cover-modal",e.style.cssText="\n    position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; z-index:11000;\n    background: rgba(0,0,0,0.4);\n  ",e.innerHTML='\n    <div style="width:980px; max-width:95%; background:white; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.2); overflow:hidden;">\n      <div style="padding:12px 16px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">\n        <strong>Icon & Cover Selector</strong>\n        <button id="w2n-close-icon-cover" style="background:none;border:none;font-size:18px;cursor:pointer">√ó</button>\n      </div>\n      <div style="display:flex; gap:12px; padding:12px;">\n        <div style="flex:1 1 60%; min-width:540px;">\n          <div id="w2n-selector-tabs" style="display:flex; gap:8px; margin-bottom:10px;">\n            <button id="w2n-tab-icons" style="padding:8px 10px; border-radius:6px; border:1px solid #e5e7eb; background:#f3f4f6; cursor:pointer;">Icons</button>\n            <button id="w2n-tab-covers" style="padding:8px 10px; border-radius:6px; border:1px solid #e5e7eb; background:white; cursor:pointer;">Covers</button>\n          </div>\n\n          <div id="w2n-selector-content">\n            <div id="w2n-icons-panel">\n                <label style="font-size:12px; color:#444">Search Emoji</label>\n                <div id="w2n-emoji-results" style="display:block; gap:6px; max-height:220px; overflow:auto; padding:8px; margin-top:8px; border:1px solid #f1f1f1; border-radius:6px; background:#fbfbfb;"></div>\n                <div style="margin-top:8px;font-size:12px;color:#666;">Or upload an icon image:</div>\n                <input type="file" id="w2n-icon-upload" accept="image/*" style="margin-top:6px;" />\n              </div>\n\n            <div id="w2n-covers-panel" style="display:none;">\n              <label style="font-size:12px; color:#444">Search Unsplash</label>\n              <div style="display:flex; gap:8px; margin-top:6px;">\n                <input id="w2n-unsplash-input" placeholder="nature, abstract, pattern" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:6px;">\n                <button id="w2n-unsplash-search-btn" style="padding:8px 10px;border-radius:6px;background:#3b82f6;color:white;border:none;">Search</button>\n              </div>\n              <div id="w2n-unsplash-cats" style="margin-top:10px; display:flex; gap:6px; flex-wrap:wrap;"></div>\n              <div id="w2n-unsplash-results" style="margin-top:12px; display:grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap:8px; max-height:420px; overflow:auto; padding:4px;"></div>\n              <div style="margin-top:8px;font-size:12px;color:#666;">Or upload a cover image:</div>\n              <input type="file" id="w2n-cover-upload" accept="image/*" style="margin-top:6px;" />\n            </div>\n          </div>\n        </div>\n        <div style="width:360px; flex-shrink:0;">\n          <label style="font-size:12px; color:#444">Preview</label>\n          <div id="w2n-icon-preview" style="height:120px; margin-top:8px; border:1px solid #eee; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:40px;"></div>\n          <label style="font-size:12px; color:#444; margin-top:8px; display:block;">Selected cover</label>\n          <div id="w2n-cover-preview" style="height:140px; margin-top:8px; border:1px solid #eee; border-radius:6px; background-size:cover; background-position:center;"></div>\n          <div style="margin-top:10px; display:flex; gap:8px;">\n            <button id="w2n-save-icon-cover" style="flex:1;padding:8px;border-radius:6px;background:#10b981;color:white;border:none;">Save</button>\n            <button id="w2n-reset-icon-cover" style="flex:1;padding:8px;border-radius:6px;background:#f59e0b;color:white;border:none;">Reset to Defaults</button>\n            <button id="w2n-cancel-icon-cover" style="flex:1;padding:8px;border-radius:6px;background:#6b7280;color:white;border:none;">Cancel</button>\n          </div>\n        </div>\n      </div>\n    </div>\n  ',document.body.appendChild(e),function(e){const t=e.querySelector("#w2n-close-icon-cover"),n=e.querySelector("#w2n-cancel-icon-cover"),o=e.querySelector("#w2n-save-icon-cover"),a=e.querySelector("#w2n-reset-icon-cover"),r=e.querySelector("#w2n-unsplash-results"),i=e.querySelector("#w2n-unsplash-input"),s=e.querySelector("#w2n-cover-preview"),l=e.querySelector("#w2n-icon-preview");let d=null,u=null,p=null,g=null;const m=e.querySelector("#w2n-unsplash-cats");m&&E.forEach(e=>{const t=document.createElement("button");t.className="w2n-unsplash-cat",t.dataset.term=e,t.textContent=e,t.style.cssText="padding:6px;border:1px solid #e5e7eb;border-radius:6px;background:#f9fafb;cursor:pointer;",t.onclick=()=>A&&A(e),m.appendChild(t)});function f(){const t=e.querySelector("#w2n-emoji-results");t.innerHTML="";["üìù","üìÑ","üìã","üìä","üöÄ","üí°","üîß","‚öôÔ∏è","üìÅ","üéØ","‚úÖ","‚ùå","‚≠ê","üî•","üíé","üé®","üîç","üìå"].forEach(e=>{const n=document.createElement("button");n.type="button",n.textContent=e,n.style.cssText="padding:6px;border-radius:6px;border:1px solid #eee;background:white;cursor:pointer;font-size:18px;",n.onclick=()=>{u=e,l.textContent=e,p=null,l.style.backgroundImage=""},t.appendChild(n)})}f();const h=e.querySelector("#w2n-icon-upload");h&&(h.onchange=e=>{const t=e.target.files[0];t&&y(t)});const b=e.querySelector("#w2n-cover-upload");b&&(b.onchange=e=>{const t=e.target.files[0];t&&x(t)});function y(e){if(!e.type.startsWith("image/"))return void w("Please select an image file for icon",3e3);const t=new FileReader;t.onload=function(t){const n=t.target.result;p={type:"file_upload",url:n,name:e.name,size:e.size,mimeType:e.type},u=null,l.style.backgroundImage=`url("${n}")`,l.style.backgroundSize="cover",l.style.backgroundPosition="center",l.textContent="",c("üìÅ Icon file uploaded and converted to data URL:",{name:e.name,size:e.size,type:e.type,dataUrlLength:n.length}),w(`Icon file "${e.name}" loaded`,2e3)},t.onerror=function(){w("Failed to read icon file",3e3),c("‚ùå Error reading icon file:",t.error)},t.readAsDataURL(e)}function x(e){if(!e.type.startsWith("image/"))return void w("Please select an image file for cover",3e3);const t=new FileReader;t.onload=function(t){const n=t.target.result;g={type:"file_upload",url:n,name:e.name,size:e.size,mimeType:e.type},d=null,s.style.backgroundImage=`url("${n}")`,s.style.backgroundSize="cover",s.style.backgroundPosition="center",c("üñºÔ∏è Cover file uploaded and converted to data URL:",{name:e.name,size:e.size,type:e.type,dataUrlLength:n.length}),w(`Cover file "${e.name}" loaded`,2e3)},t.onerror=function(){w("Failed to read cover file",3e3),c("‚ùå Error reading cover file:",t.error)},t.readAsDataURL(e)}function w(e,t=3e3){"undefined"!=typeof GM_notification?GM_notification({text:e,title:"ServiceNow",timeout:t}):c(`[Toast] ${e}`)}t.onclick=()=>{e.remove()},n.onclick=()=>{e.remove()};const S=e.querySelector("#w2n-tab-icons"),T=e.querySelector("#w2n-tab-covers"),C=e.querySelector("#w2n-icons-panel"),$=e.querySelector("#w2n-covers-panel");function N(e){"icons"===e?(C.style.display="block",$.style.display="none",S.style.background="#f3f4f6",T.style.background="white"):(C.style.display="none",$.style.display="block",S.style.background="white",T.style.background="#f3f4f6")}async function A(e){c(`üîç Running Unsplash search for: "${e}"`),r.innerHTML='<div style="grid-column:1/-1;padding:18px;color:#666;text-align:center;">Searching...</div>';try{const t=await async function(e,t={}){c(`üîç Searching Unsplash for: "${e}"`);try{const n=new URLSearchParams({query:e});t.page&&n.set("page",t.page.toString()),t.per_page&&n.set("per_page",t.per_page.toString());const o=await v("GET",`/api/unsplash/search?${n.toString()}`);if(o&&o.success){const e=o.photos||o.images||[];return c(`‚úÖ Found ${e.length} Unsplash images`),{success:!0,photos:e,total:o.total||e.length}}return{success:!1,photos:[],error:o?.error}}catch(e){throw c("‚ùå Failed to search Unsplash:",e),e}}(e);if(c("üîç Unsplash search response:",t),!t||!t.success)return c("‚ùå API response indicates failure:",t),void(r.innerHTML='<div style="grid-column:1/-1;padding:18px;color:#666;text-align:center;">API returned error</div>');const n=t?.photos||t?.images||[];if(c(`üîç Found ${n.length} photos`),0===n.length)return void(r.innerHTML='<div style="grid-column:1/-1;padding:18px;color:#666;text-align:center;">No images found for this search</div>');k(n)}catch(e){c("‚ùå Unsplash search error:",e),r.innerHTML='<div style="grid-column:1/-1;padding:18px;color:#666;text-align:center;">Search failed: '+(e.message||"Unknown error")+"</div>"}}function k(e){if(c(`üñºÔ∏è Displaying ${e?.length||0} Unsplash images`),r.innerHTML="",!e||0===e.length)return c("‚ùå No images to display"),void(r.innerHTML='<div style="grid-column:1/-1;padding:18px;color:#666;text-align:center;">No images</div>');e.forEach((e,t)=>{const n=e.url||e.full||e.urls?.regular||e.urls?.full||e.src||e.thumb||"",o=e.thumb||e.urls?.thumb||(n?`${n}&w=300&h=200&fit=crop`:"");c(`üñºÔ∏è Image ${t+1}: url=${n?.substring(0,50)}..., thumb=${o?.substring(0,50)}...`);const a=document.createElement("div");a.style.cssText=`width:100%; aspect-ratio:16/9; border-radius:6px; background-image:url("${o}"); background-size:cover; background-position:center; cursor:pointer;`,a.title=e.alt_description||e.alt||"",a.onclick=()=>{d=n,g=null,s.style.backgroundImage=`url("${n}")`,c(`üñºÔ∏è Selected cover: ${n?.substring(0,50)}...`)},r.appendChild(a)})}S.onclick=()=>N("icons"),T.onclick=()=>N("covers"),N("icons"),e.querySelectorAll(".w2n-unsplash-cat").forEach(e=>{e.onclick=()=>{const t=e.dataset.term;i.value=t,A(t)}}),e.querySelector("#w2n-unsplash-search-btn").onclick=()=>{A(i.value)},o.onclick=()=>{const t=p||(u?{type:"emoji",emoji:u}:null),n=g||(d?{type:"url",url:d}:null);e.onSave&&"function"==typeof e.onSave&&e.onSave({icon:t,cover:n}),e.remove()},a.onclick=()=>{d=null,u=null,p=null,g=null,l.textContent="",l.style.backgroundImage="",s.style.backgroundImage="",w("Selection reset",1500)},(async()=>{c("üñºÔ∏è Loading default Unsplash images..."),r.innerHTML='<div style="grid-column:1/-1;padding:18px;color:#666;text-align:center;">Loading defaults...</div>';try{const e=await async function(){c("üñºÔ∏è Fetching default Unsplash images");try{const e=await v("GET","/api/unsplash/defaults");if(e&&e.success){const t=e.photos||e.images||[];return c(`‚úÖ Retrieved ${t.length} default images`),{success:!0,photos:t}}return{success:!1,photos:[]}}catch(e){return c("‚ùå Failed to fetch default images:",e),{success:!1,photos:[]}}}();c("üñºÔ∏è Default images response:",e);const t=e?.photos||e?.images||[];c(`üñºÔ∏è Found ${t.length} default photos`),k(t)}catch(e){c("‚ùå Default images error:",e),r.innerHTML='<div style="grid-column:1/-1;padding:18px;color:#666;text-align:center;">No default images available</div>'}})(),e.getSelections=()=>({icon:p||(u?{type:"emoji",emoji:u}:null),cover:g||(d?{type:"url",url:d}:null)})}(e)}async function $(e){if(!e)throw new Error("Database ID is required");c(`üîç Getting database: ${e}`);const t=await async function(e){return new Promise(t=>{const n=`database_${e}`;if("function"==typeof GM_getValue)try{const e=GM_getValue(n,null);if(e){const n=JSON.parse(e);if(Date.now()-n.timestamp<36e5)return void t(n.database)}}catch(e){c("‚ùå Failed to parse cached database:",e)}t(null)})}(e);if(t)return c("‚úÖ Using cached database schema"),c("üìã Cached properties:",t.properties?Object.keys(t.properties):"No properties"),t;try{const t=await S(e);return await N(e,t),t}catch(e){throw c("‚ùå Failed to get database:",e),e}}async function N(e,t){if("function"==typeof GM_setValue)try{const n=`database_${e}`,o={database:t,timestamp:Date.now()};GM_setValue(n,JSON.stringify(o)),c("‚úÖ Database cached successfully")}catch(e){c("‚ùå Failed to cache database:",e)}}async function A(e){if(!e)throw new Error("Database ID is required");c(`üîÑ Force refreshing database: ${e}`),function(e){if("function"==typeof GM_setValue&&e)try{const t=`database_${e}`;GM_setValue(t,null),c(`üóëÔ∏è Cleared database cache for: ${e}`)}catch(e){c("‚ùå Failed to clear database cache:",e)}}(e);try{const t=await S(e);return await N(e,t),c("‚úÖ Database schema refreshed successfully"),t}catch(e){throw c("‚ùå Failed to refresh database:",e),e}}async function k(e={}){c("üìä Getting all databases");try{const t=await async function(e={}){c("üìä Fetching available databases");try{const t=[];let n=null,o=!0;const a=e.limit||100;for(;o;){const r=new URLSearchParams;e.search&&r.set("search",e.search),r.set("limit",a.toString()),n&&r.set("start_cursor",n);const i="/api/databases"+(r.toString()?"?"+r.toString():""),s=await v("GET",i);if(s&&s.success&&s.data){const e=s.data.results||[];t.push(...e),o=s.data.has_more||!1,n=s.data.next_cursor||null,c(`üìÑ Fetched page with ${e.length} databases, total: ${t.length}, has_more: ${o}`)}else o=!1}return c(`‚úÖ Found ${t.length} databases total`),t}catch(e){throw c("‚ùå Failed to fetch databases:",e),e}}(e),n=t.filter(e=>e&&e.id&&e.title&&e.title.length>0);return c(`‚úÖ Retrieved ${n.length} accessible databases`),n}catch(e){return c("‚ùå Failed to get databases:",e),[]}}function P(e,t,n){c("üîß Applying property mappings");const o={},a=t.properties||{};return Object.entries(n).forEach(([t,n])=>{if(!n||!a[t])return;const r=a[t],i=(s=e,(l=n)&&s?l.split(".").reduce((e,t)=>e&&void 0!==e[t]?e[t]:void 0,s):void 0);var s,l;if(null!=i&&""!==i){const e=function(e,t){if(!t||null==e)return null;const n=t.type,o=String(e).trim();if(!o)return null;switch(n){case"title":return{title:[{type:"text",text:{content:o.slice(0,2e3)}}]};case"rich_text":return{rich_text:[{type:"text",text:{content:o.slice(0,2e3)}}]};case"number":const e=parseFloat(o);return isNaN(e)?null:{number:e};case"select":const a=(t.select?.options||[]).find(e=>e.name.toLowerCase()===o.toLowerCase());return a?{select:{name:a.name}}:null;case"multi_select":const r=t.multi_select?.options||[],i=o.split(",").map(e=>e.trim()).map(e=>r.find(t=>t.name.toLowerCase()===e.toLowerCase())).filter(Boolean);return i.length>0?{multi_select:i.map(e=>({name:e.name}))}:null;case"date":try{const e=new Date(o);return isNaN(e.getTime())?null:{date:{start:e.toISOString().split("T")[0]}}}catch(e){return null}case"checkbox":const s=o.toLowerCase();return{checkbox:"true"===s||"yes"===s||"1"===s};case"url":try{return new URL(o),{url:o}}catch(e){return null}case"email":return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o)?{email:o}:null;case"phone_number":return{phone_number:o};case"people":case"relation":return null;default:return c(`‚ö†Ô∏è Unsupported property type: ${n}`),null}}(i,r);null!==e&&(o[t]=e)}}),c(`‚úÖ Applied ${Object.keys(o).length} property mappings`),o}function M(){if(document.getElementById("w2n-property-mapping-modal"))return;const e=document.createElement("div");e.id="w2n-property-mapping-modal",e.style.cssText="\n    position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; z-index:11000;\n    background: rgba(0,0,0,0.4);\n  ",e.innerHTML='\n    <div style="width:600px; max-width:95%; background:white; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.2); overflow:hidden;">\n      <div style="padding:16px 20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">\n        <strong>üîó Property Mapping</strong>\n        <div style="display:flex; align-items:center; gap:10px;">\n          <button id="w2n-refresh-property-mapping" title="Refresh database schema" style="background:#3b82f6;color:white;border:none;border-radius:4px;padding:4px 8px;font-size:12px;cursor:pointer;">\n            üîÑ Refresh\n          </button>\n          <button id="w2n-close-property-mapping" style="background:none;border:none;font-size:18px;cursor:pointer">√ó</button>\n        </div>\n      </div>\n      <div style="padding:20px;">\n        <div style="margin-bottom:16px; font-size:14px; color:#6b7280;">\n          Map content from this page to database properties in: <strong id="w2n-mapping-db-name">Selected Database</strong>\n        </div>\n        \n        <div id="w2n-property-mappings" style="margin-bottom:20px; max-height:300px; overflow-y:auto;">\n          \x3c!-- Property mappings will be populated here --\x3e\n        </div>\n        \n        <div style="display:flex; gap:10px; padding-top:16px; border-top:1px solid #eee;">\n          <button id="w2n-save-property-mapping" style="flex:1;padding:10px;border-radius:6px;background:#10b981;color:white;border:none;cursor:pointer;font-size:14px;">\n            Save Mapping\n          </button>\n          <button id="w2n-reset-property-mapping" style="padding:10px 16px;border-radius:6px;background:#ef4444;color:white;border:none;cursor:pointer;font-size:14px;">\n            Reset\n          </button>\n          <button id="w2n-cancel-property-mapping" style="flex:1;padding:10px;border-radius:6px;background:#6b7280;color:white;border:none;cursor:pointer;font-size:14px;">\n            Cancel\n          </button>\n        </div>\n      </div>\n    </div>\n  ',document.body.appendChild(e),function(e){if(!e)return;if(e.dataset&&e.dataset.w2nInit)return;const t=e.querySelector("#w2n-close-property-mapping"),n=e.querySelector("#w2n-save-property-mapping"),o=e.querySelector("#w2n-reset-property-mapping"),a=e.querySelector("#w2n-cancel-property-mapping"),r=e.querySelector("#w2n-refresh-property-mapping"),s=e.querySelector("#w2n-property-mappings"),l=e.querySelector("#w2n-mapping-db-name");let d=null,u={};function p(){e.parentNode&&e.parentNode.removeChild(e)}t.onclick=p,a.onclick=p,e.onclick=t=>{t.target===e&&p()},n.addEventListener("click",async()=>{try{const e=i().databaseId;if(!e)return void alert("No database selected. Please select a database first.");const t={};s.querySelectorAll("select").forEach(e=>{const n=e.dataset.contentKey,o=e.value;o&&""!==o&&(t[o]=n)}),function(e,t){const n=`w2n_property_mappings_${e}`;"undefined"!=typeof GM_setValue&&GM_setValue(n,JSON.stringify(t));c(`Property mappings saved for database ${e}:`,t)}(e,t),alert("Property mappings saved successfully!"),p()}catch(e){c("Error saving property mappings:",e),alert("Error saving property mappings. Check console for details.")}});try{e.dataset=e.dataset||{},e.dataset.w2nInit="1"}catch(e){}async function g(e,t,n=!1){try{l.textContent=t||"Loading...",s.innerHTML='<div style="text-align:center;padding:20px;color:#6b7280;">Loading database schema...</div>',n?(c("üîÑ Force refreshing database schema"),d=await A(e)):d=await $(e);const o=function(e){const t=`w2n_property_mappings_${e}`;if("undefined"==typeof GM_getValue)return{};const n=GM_getValue(t,"{}");try{return JSON.parse(n)}catch(e){return c("Error loading property mappings:",e),{}}}(e);u={...o},function(e,t){c("Populating property mappings with properties:",e);const n=[{key:"title",label:"Page Title",description:"The main title of the captured page"},{key:"url",label:"Page URL",description:"The URL of the captured page"},{key:"source",label:"Content Source",description:'The source platform (e.g., "ServiceNow")'},{key:"category",label:"Category",description:"ServiceNow category or classification"},{key:"section",label:"Section",description:"ServiceNow documentation section from breadcrumb path"},{key:"version",label:"Version",description:"Version information"},{key:"updated",label:"Updated Date",description:"Last updated date"},{key:"CurrentReleaseURL",label:"Current Release URL",description:"The latest version URL or permanent link to the content"},{key:"breadcrumb",label:"Breadcrumb",description:"Navigation breadcrumb or content hierarchy path"},{key:"hasVideos",label:"Has Videos",description:"Automatically detected - indicates if the page contains video content"},{key:"hasFigureImage",label:"Has Images",description:"Automatically detected - indicates if the page contains images or figures"}],o=Object.entries(e).map(([e,t])=>{const n=t.type||"unknown";return`<option value="${e}">[${n.charAt(0).toUpperCase()+n.slice(1)}] ${t.name||e}</option>`}).join(""),a=n.map(e=>(t[e.key],`\n      <div style="margin-bottom:12px; padding:12px; border:1px solid #e5e7eb; border-radius:6px;">\n        <div style="display:flex; align-items:center; gap:12px;">\n          <div style="flex:1; min-width:160px;">\n            <strong style="font-size:13px;">${e.label}</strong>\n            <div style="font-size:11px; color:#6b7280; margin-top:2px;">${e.description}</div>\n          </div>\n          <div style="flex:1; min-width:200px;">\n            <select data-content-key="${e.key}" style="width:100%; padding:6px; border:1px solid #d1d5db; border-radius:4px; font-size:12px;">\n              <option value="">-- No mapping --</option>\n              ${o}\n            </select>\n          </div>\n        </div>\n      </div>\n    `)).join(""),r=document.querySelector("#w2n-property-mappings");r&&(r.innerHTML=a,Object.entries(t).forEach(([e,t])=>{const n=r.querySelector(`select[data-content-key="${t}"]`);n&&(n.value=e)}))}(d.properties,u),l.textContent=t||d.title?.[0]?.text?.content||"Unknown Database",n&&c("‚úÖ Database schema refreshed")}catch(e){c("‚ùå Failed to load database schema:",e),s.innerHTML='<div style="text-align:center;padding:20px;color:#ef4444;">Failed to load database schema. Please try again.</div>'}}o.addEventListener("click",()=>{if(confirm("Are you sure you want to reset all property mappings to default?")){const e=i().databaseId;e&&(!function(e){const t=`w2n_property_mappings_${e}`;"undefined"!=typeof GM_setValue&&GM_setValue(t,"{}");c(`Property mappings reset for database ${e}`)}(e),L())}}),r.addEventListener("click",async()=>{const e=i();e.databaseId?(c("üîÑ Refreshing database schema..."),await g(e.databaseId,e.databaseName,!0)):alert("No database selected. Please select a database first.")}),e.loadDatabaseMappings=g;const m=i();m.databaseId&&g(m.databaseId,m.databaseName||"Selected Database");"undefined"!=typeof unsafeWindow&&(unsafeWindow.propertyMappingModal=e)}(e)}function L(){c("üîó Opening property mapping modal"),M();const e=document.getElementById("w2n-property-mapping-modal"),t=i();e&&e.loadDatabaseMappings&&e.loadDatabaseMappings(t.databaseId,t.databaseName)}function D(e,n=3e3){if("undefined"!=typeof GM_notification)GM_notification({text:e,title:t,timeout:n});else try{c(`[${t}] ${e}`)}catch(n){console.info(`[${t}] ${e}`)}}function I(e,t={},n=""){const o=document.createElement(e);return Object.entries(t).forEach(([e,t])=>{"class"===e?o.className=t:"style"===e?o.style.cssText=t:o.setAttribute(e,t)}),n&&(o.textContent=n),o}function R(e){if(!e||0===e.length)return 0;let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t|=0}return t}function _(e){if(e||(e=document.getElementById("w2n-notion-panel")),!e)return;if(e.dataset&&e.dataset.w2nInit)return;const t=()=>{const t=e.querySelector("#w2n-db-spinner");t&&(t.style.display="flex")},n=()=>{const t=e.querySelector("#w2n-db-spinner");t&&(t.style.display="none")},o=e.querySelector("#w2n-close"),a=e.querySelector("#w2n-advanced-settings-btn"),r=e.querySelector("#w2n-capture-page"),s=e.querySelector("#w2n-configure-mapping"),l=e.querySelector("#w2n-open-icon-cover");o.onclick=()=>e.remove(),a&&(a.onclick=e=>{e.stopPropagation();try{w()}catch(e){c("Failed to open advanced settings modal from panel:",e)}}),r.onclick=async()=>{try{if(window.ServiceNowToNotion&&"function"==typeof window.ServiceNowToNotion.app){const e=window.ServiceNowToNotion.app();e&&"function"==typeof e.handleMainAction&&await e.handleMainAction()}}catch(e){c("Failed to execute capture action:",e)}},s.onclick=()=>{try{L()}catch(e){c("Failed to open property mapping modal:",e)}},l.onclick=()=>{try{C()}catch(e){c("Failed to open icon cover modal:",e)}};const d=e.querySelector("#w2n-refresh-dbs"),u=e.querySelector("#w2n-search-dbs"),p=e.querySelector("#w2n-get-db"),g=e.querySelector("#w2n-database-select"),m=e.querySelector("#w2n-selected-database-label");d&&(d.onclick=async()=>{try{c("üîÑ Refreshing database list..."),t();const e=await k({forceRefresh:!0});!function(e,t){if(!e)return;e.innerHTML='<option value="">Select a database...</option>',t.forEach(t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.title&&t.title[0]?t.title[0].plain_text:"Untitled Database",e.appendChild(n)})}(g,e),c(`[DATABASE] ‚úÖ Refreshed ${e.length} databases`)}catch(e){c("Failed to refresh databases:",e)}finally{n()}}),u&&(u.onclick=async()=>{try{const e=prompt("Enter database name or ID to search:");if(!e||""===e.trim())return;c(`[DATABASE] üîç Searching for database: ${e}`),t();const n=await k({forceRefresh:!0});c(`üìã Available databases: ${n.map(e=>`${e.id.slice(-8)}: ${e.title||"Untitled"}`).join(", ")}`);const o=e.trim();let a=n.find(e=>e.id===o||e.title&&"string"==typeof e.title&&e.title.toLowerCase().includes(o.toLowerCase()));if(!a&&o.length>=8){const e=o.slice(-8);a=n.find(t=>t.id.endsWith(e)),a&&c(`[DATABASE] ‚úÖ Found database by partial ID match: ${e}`)}if(a){const e=i();e.databaseId=a.id,e.databaseName="string"==typeof a.title?a.title:"Unknown Database","function"==typeof GM_setValue&&GM_setValue("notionConfig",e),g.innerHTML=`<option value="${a.id}">${e.databaseName}</option>`,m.textContent=`Database: ${e.databaseName}`,c(`‚úÖ Set target database to: ${e.databaseName} (${a.id})`)}else alert(`Database "${e}" not found.`),c(`[DATABASE] ‚ùå Database "${e}" not found`)}catch(e){c("Failed to search database:",e),alert("Error searching for database. Check console for details.")}finally{n()}}),p&&(p.onclick=async()=>{try{const e=prompt("Enter database ID:");if(!e||""===e.trim())return;const n=e.trim();c(`[DATABASE] üîç Getting database by ID: ${n}`),t();const o=await $(n),a=i();a.databaseId=n,a.databaseName=o.title||"Database by ID","function"==typeof GM_setValue&&GM_setValue("notionConfig",a),g.innerHTML=`<option value="${n}">${a.databaseName}</option>`,m.textContent=`Database: ${a.databaseName}`,c(`‚úÖ Set target database to: ${a.databaseName} (${n})`)}catch(e){c("Failed to get database by ID:",e),alert(`Error: Could not access database with ID "${dbId}". Make sure the database is shared with your Notion integration.`)}finally{n()}});const f=GM_getValue("w2n_autoExtractState");if(c("[STATE-MANAGEMENT] üîç Checking for saved autoExtractState: "+(f?"FOUND":"NOT FOUND")),f)try{const e=JSON.parse(f);c("[STATE-MANAGEMENT] üîÑ Found saved autoExtractState from page reload:",e);const t=e.reloadAttempts||0;if(t>3)return c("[STATE-MANAGEMENT] ‚ùå Maximum reload attempts (3) exceeded - not resuming"),alert(`‚ùå AutoExtract stopped: Maximum reload attempts (3) exceeded.\n\nThe page failed to load properly after 3 reload attempts.\n\nTotal pages processed: ${e.totalProcessed||0}`),void GM_setValue("w2n_autoExtractState",null);GM_setValue("w2n_autoExtractState",null),setTimeout(async()=>{c(`[STATE-MANAGEMENT] ‚ñ∂Ô∏è Resuming auto-extraction after page reload (attempt ${t}/3)...`),await async function(e){c("[AUTO-EXTRACT] ‚ñ∂Ô∏è Resuming auto-extraction with saved state:",e);const t={...e,running:!0,paused:!1,processedUrls:new Set(e.processedUrls||[])};window.ServiceNowToNotion=window.ServiceNowToNotion||{},window.ServiceNowToNotion.autoExtractState=t;const n=document.querySelector("#w2n-start-autoextract"),o=document.querySelector("#w2n-stop-autoextract");n&&(n.style.display="none");o&&(o.style.display="block");D(`üîÑ Resumed auto-extraction after page reload (page ${t.currentPage+1})`,5e3);try{await async function(e){c("[AUTO-EXTRACT] üîÑ Continuing AutoExtract loop from saved state"),c(`[AUTO-EXTRACT] üìä Resumed state: currentPage=${e.currentPage}, totalProcessed=${e.totalProcessed}`);const t=window.ServiceNowToNotion?.app?.(),n="function"==typeof GM_getValue?GM_getValue("w2n_next_page_selector","div.zDocsNextTopicButton a"):"div.zDocsNextTopicButton a",o=document.getElementById("w2n-start-autoextract");c("‚è≥ Waiting additional time after page reload for full stabilization..."),o&&(o.textContent="Waiting for page to load...");await new Promise(e=>setTimeout(e,3e3));for(;e.running&&!e.paused;){c(`[AUTO-EXTRACT] \nüîÑ Loop iteration: currentPage=${e.currentPage}`),e.currentPage++;const a=e.currentPage;c(`[AUTO-EXTRACT] üìÑ Processing page number: ${a}`),y.setMessage(`Extracting page ${a}...`),o&&(o.textContent=`Processing page ${a}...`);try{const r=window.location.href,i=G();if(e.processedUrls.has(r)){if(c(`‚ö†Ô∏è DUPLICATE URL DETECTED: ${r}`),c("‚ùå This URL was already processed in this session!"),e.duplicateCount=(e.duplicateCount||0)+1,e.duplicateCount>=3){const t=`AutoExtract stopped: Same page detected ${e.duplicateCount} times in a row.\n\nURL: ${r}\n\nThis usually means the "Next Page" button is not working correctly or you've reached a loop in the navigation.\n\nTotal pages processed: ${e.totalProcessed}`;return alert(t),B(e),void(o&&(o.textContent="Start AutoExtract"))}c(`‚è≠Ô∏è Skipping duplicate page (count: ${e.duplicateCount})...`)}else e.duplicateCount=0;c(`[AUTO-EXTRACT] üìù Step 1: Extracting content from page ${a}...`),y.setMessage(`Extracting content from page ${a}...`);const s=await t.extractCurrentPageData();if(!s)throw new Error("No content extracted from page");if(e.processedUrls.has(r))c("‚è≠Ô∏è Skipping Notion processing for duplicate URL");else{e.processedUrls.add(r),e.lastPageId=i,c(`[AUTO-EXTRACT] üì§ Saving page ${a} to Notion...`),y.setMessage(`Processing page ${a}...`),await t.processWithProxy(s);e.totalProcessed++,c(`[AUTO-EXTRACT] ‚úÖ Page ${a} saved to Notion`),y.setMessage(`‚úì Page ${a} saved! Continuing...`)}const l=window.location.href,d=i;if(!await F(n,e,o))return c("[NEXT-BUTTON] ‚ùå Could not find next page button after reload attempt"),y.done({success:!1,pageUrl:null,autoCloseMs:0}),D(`‚ùå Could not find next page button. AutoExtract stopped after ${e.totalProcessed} page(s).`,5e3),B(e),void(o&&(o.textContent="Start AutoExtract"));c("[AUTO-EXTRACT] ‚è≥ Step 4: Waiting for page navigation..."),o&&(o.textContent=`Loading page ${a+1}...`),await new Promise(e=>setTimeout(e,3e3)),c(`[AUTO-EXTRACT] ‚è≥ Step 5: Stabilizing page ${a+1}...`),await new Promise(e=>setTimeout(e,1e3));const u=window.location.href,p=G();u===l&&p===d?(c("‚ö†Ô∏è WARNING: URL and Page ID did not change after clicking next button!"),c(`   Before: ${l} | ${d}`),c(`   After:  ${u} | ${p}`),c("‚ö†Ô∏è Navigation may have failed - the same page will be detected as duplicate on next iteration")):(c("‚úÖ Navigation verified: Page changed successfully"),c(`   New URL: ${u}`),c(`   New Page ID: ${p}`)),c(`‚úÖ Page ${a+1} fully loaded and ready for capture!`),c("\n========================================"),c(`üîÑ Looping back to capture page ${a+1}...`),c("========================================\n")}catch(t){c("‚ùå Error in AutoExtract loop:",t);const n=`‚ùå AutoExtract ERROR: ${t.message}\n\nTotal pages processed: ${e.totalProcessed}`;return alert(n),B(e),o&&(o.textContent=`‚ùå Error: ${t.message.substring(0,20)}...`),void y.error({message:`AutoExtract failed: ${t.message}`})}}c(`[AUTO-EXTRACT] üéâ AutoExtract completed! Total pages processed: ${e.totalProcessed}`),y.done({success:!0,pageUrl:null,autoCloseMs:5e3}),D(`‚úÖ AutoExtract complete! Processed ${e.totalProcessed} page(s)`,5e3),B(e),o&&(o.textContent="Start AutoExtract")}(t)}catch(e){c("[AUTO-EXTRACT] ‚ùå Error resuming auto-extraction:",e);const n=`‚ùå Resume AutoExtract ERROR: ${e.message}\n\nTotal pages processed: ${t.totalProcessed}`;alert(n),B(t)}}(e)},2e3)}catch(e){c("[STATE-MANAGEMENT] ‚ùå Error parsing saved autoExtractState:",e),GM_setValue("w2n_autoExtractState",null)}const h=e.querySelector("#w2n-start-autoextract"),b=e.querySelector("#w2n-stop-autoextract"),x=e.querySelector("#w2n-diagnose-autoextract");h&&(h.onclick=async()=>{try{h.style.display="none",b&&(b.style.display="block"),await async function(){if(!i().databaseId)return void alert("Please select a database first.");const e="function"==typeof GM_getValue?GM_getValue("w2n_next_page_selector","div.zDocsNextTopicButton a"):"div.zDocsNextTopicButton a";if(!e)return void alert("Please select a 'Next Page' element first using the 'Select Next Page Element' button.");if(!window.ServiceNowToNotion||"function"!=typeof window.ServiceNowToNotion.app)return void alert("App instance not available. Please refresh the page.");const t=window.ServiceNowToNotion.app();if(!t)return void alert("App instance not available. Please refresh the page.");c(`Starting auto-extraction using selector: ${e}`);const n={running:!0,currentPage:0,totalProcessed:0,paused:!1,reloadAttempts:0,lastContentHash:null,duplicateCount:0,processedUrls:new Set,lastPageId:null},o=e=>{if(n.running){c("[STATE-MANAGEMENT] ‚ö†Ô∏è Page unloading during AutoExtract - saving state...");const e={...n,reloadAttempts:(n.reloadAttempts||0)+1,processedUrls:Array.from(n.processedUrls||[])};GM_setValue("w2n_autoExtractState",JSON.stringify(e))}};window.addEventListener("beforeunload",o);try{y.done({success:!0,autoCloseMs:0}),window.ServiceNowToNotion=window.ServiceNowToNotion||{},window.ServiceNowToNotion.autoExtractState=n,y.start("Starting multi-page extraction..."),await async function(e,t,n){c("üîÑ Starting AutoExtract loop");const o=document.getElementById("w2n-start-autoextract");for(;e.running&&!e.paused;){if(!e.running)return c("[AUTO-EXTRACT] ‚èπ AutoExtract stopped at beginning of loop iteration"),B(e),void(o&&(o.textContent="Start AutoExtract"));e.currentPage++;const a=e.currentPage;c(`[AUTO-EXTRACT] üìÑ Processing page number: ${a}`),y.setMessage(`Extracting page ${a}...`),o&&(o.textContent=`Processing page ${a}...`);try{let r=0;const i=3;for(;O()&&r<i;){r++,c(`üîí Access limited detected, attempting reload ${r}/${i}...`),D(`‚ö†Ô∏è Page access limited, reloading (attempt ${r}/${i})...`,5e3),o&&(o.textContent=`Reloading for access (${r}/${i})...`);!await z(15e3)&&r<i&&(c(`‚è≥ Access limited reload ${r} failed, waiting 5s before retry...`),await H(5,"‚è≥ Reload failed. Retrying in..."))}if(r>0&&!O()&&(c(`[ACCESS-LIMITED] ‚úÖ Access-limited resolved after ${r} reload(s), stabilizing page...`),y.setMessage("Page access restored, stabilizing..."),await new Promise(e=>setTimeout(e,3e3))),O()){c(`[ACCESS-LIMITED] üîí Access limited persists after ${i} reload attempts, skipping page ${a}...`),D(`‚äò Skipped page ${a}: Access limited (after ${i} reloads)`,4e3),o&&(o.textContent=`Skipped page ${a} (access limited)`),c("\n========================================"),c(`‚äò Skipped page ${a} due to persistent access limited`),c(`üéØ Now navigating to page ${a+1}...`),c("========================================\n"),c("üîç Finding next page button after skip..."),y.setMessage("Finding next page button...");const t=await F(n,e,o);if(!t){const t=`‚ùå AutoExtract STOPPED: Next page button could not be found after skipping page ${a}.\n\nTotal pages processed: ${e.totalProcessed}`;return alert(t),B(e),void(o&&(o.textContent="Start AutoExtract"))}if(!e.running)return c(`[AUTO-EXTRACT] ‚èπ AutoExtract stopped by user after skipping page ${a}`),D(`‚èπ AutoExtract stopped. Processed ${e.totalProcessed} pages.`,4e3),B(e),void(o&&(o.textContent="Start AutoExtract"));c(`üéØ Now navigating to page ${a+1}...`),y.setMessage(`Navigating to page ${a+1}...`),o&&(o.textContent=`Navigating to page ${a+1}...`);const r=window.location.href,s=document.title,l=G(),d=document.querySelector('main, .main-content, [role="main"]'),u=d?d.innerHTML.length:0;await W(t),c("‚úÖ Click executed, waiting for page to navigate..."),c(`‚è≥ Waiting for navigation to page ${a+1}...`);if(!await j(r,s,l,u,15e3)){const t=`‚ùå AutoExtract STOPPED: Navigation to page ${a+1} failed.\n\nTotal pages processed: ${e.totalProcessed}`;return alert(t),B(e),void(o&&(o.textContent="‚ùå Stopped: Navigation failed"))}c(`‚úÖ Navigation detected! Page ${a+1} URL loaded.`),c(`‚è≥ Waiting for page ${a+1} content to load...`),y.setMessage(`Loading page ${a+1} content...`),o&&(o.textContent=`Loading page ${a+1}...`),await new Promise(e=>setTimeout(e,3e3)),c(`‚è≥ Stabilizing page ${a+1}...`),await new Promise(e=>setTimeout(e,1e3)),c(`[AUTO-EXTRACT] ‚úÖ Page ${a+1} fully loaded and ready for capture!`),c("[AUTO-EXTRACT] \n========================================"),c(`[AUTO-EXTRACT] üîÑ Looping back to capture page ${a+1}...`),c("[AUTO-EXTRACT] ========================================\n");continue}let s=0;const l=3;for(;U()&&s<l;){s++,c(`üö® 503 error detected, attempting reload ${s}/${l}...`),D(`‚ö†Ô∏è 503 error detected, reloading page (attempt ${s}/${l})...`,5e3),o&&(o.textContent=`Reloading page (${s}/${l})...`);!await z(15e3)&&s<l&&(c(`‚è≥ Reload ${s} failed, waiting 5s before retry...`),await H(5,"‚è≥ 503 error reload failed. Retrying in..."))}if(U()){const t=`‚ùå AutoExtract STOPPED: Page ${a} shows 503 error after ${l} reload attempts.\n\nTotal pages processed: ${e.totalProcessed}`;return alert(t),B(e),void(o&&(o.textContent="‚ùå Stopped: 503 Error"))}c(`[AUTO-EXTRACT] üìÑ Step 1: Extracting page ${a}...`);let d=!1,u=0;const p=3;let g=!1;for(;u<p&&!d;){u++;try{if(u>1){if(!e.running)return c(`[AUTO-EXTRACT] ‚èπ AutoExtract stopped before retry delay for page ${a}`),D(`‚èπ AutoExtract stopped. Processed ${e.totalProcessed} pages.`,4e3),B(e),void(o&&(o.textContent="Start AutoExtract"));if(D(`Retry ${u-1}/2: Extracting page ${a}...`,3e3),o&&(o.textContent=`Retry ${u-1}/2: Extracting page ${a}...`),await new Promise(e=>setTimeout(e,2e3)),!e.running)return c(`[AUTO-EXTRACT] ‚èπ AutoExtract stopped after retry delay for page ${a}`),D(`‚èπ AutoExtract stopped. Processed ${e.totalProcessed} pages.`,4e3),B(e),void(o&&(o.textContent="Start AutoExtract"))}const n=await t.extractCurrentPageData(),r=n.content?.combinedHtml||"",i=R(r);if(c(`[CONTENT-HASH] üîç Content to hash length: ${r.length} characters`),c(`[CONTENT-HASH] üîç Calculated hash: ${i}, Previous hash: ${e.lastContentHash}`),i===e.lastContentHash){if(e.duplicateCount++,c(`[CONTENT-HASH] ‚ö†Ô∏è DUPLICATE CONTENT DETECTED (${e.duplicateCount} consecutive)!`),c(`[CONTENT-HASH] Hash: ${i}, Last Hash: ${e.lastContentHash}`),e.duplicateCount>=3){const t=`‚ùå AutoExtract STOPPED: Same page content detected ${e.duplicateCount} times in a row.\n\nThis usually means:\n- ServiceNow navigation isn't working\n- You've reached the end of the section\n- There's a navigation loop\n\nTotal pages processed: ${e.totalProcessed}\nLast successful page: ${a-e.duplicateCount}`;return alert(t),B(e),void(o&&(o.textContent="‚ùå Stopped: Duplicate content"))}c("[CONTENT-HASH] ‚äò Skipping duplicate content, will retry navigation without creating page..."),D(`‚ö†Ô∏è Duplicate content #${e.duplicateCount}, skipping to navigation...`,3e3),g=!0;break}if(e.duplicateCount=0,e.lastContentHash=i,c(`[CONTENT-HASH] ‚úÖ Content is unique (hash: ${i})`),!e.running)return c(`[AUTO-EXTRACT] ‚èπ AutoExtract stop requested before creating page ${a}`),D(`‚èπ AutoExtract stopped before page ${a}. Processed ${e.totalProcessed} pages.`,4e3),B(e),void(o&&(o.textContent="Start AutoExtract"));c(`[AUTO-EXTRACT] üíæ Step 2: Creating Notion page for page ${a}...`),y.setMessage(`Creating Notion page ${a}...`),await t.processWithProxy(n),d=!0,e.totalProcessed++,c(`‚úÖ Page ${a} captured and saved to Notion successfully${u>1?` (attempt ${u})`:""}`),await new Promise(e=>setTimeout(e,2e3))}catch(t){if(c(`‚ùå Capture attempt ${u} failed for page ${a}:`,t),!e.running)return c(`[AUTO-EXTRACT] ‚èπ AutoExtract stopped during error handling for page ${a}`),D(`‚èπ AutoExtract stopped. Processed ${e.totalProcessed} pages.`,4e3),B(e),void(o&&(o.textContent="Start AutoExtract"));if(t.message&&(t.message.includes("Proxy server is not available")||t.message.includes("fetch failed")||t.message.includes("Failed to fetch")||t.message.includes("Network request failed")||t.message.includes("ECONNREFUSED")||t.message.toLowerCase().includes("connection"))){const n=`‚ùå AutoExtract STOPPED: Server appears to be offline.\n\nError: ${t.message}\n\nPlease check that the proxy server is running and try again.\n\nTotal pages processed: ${e.totalProcessed}`;return alert(n),B(e),void(o&&(o.textContent="‚ùå Stopped: Server offline"))}u<p&&D(`‚ö†Ô∏è Page capture failed (attempt ${u}/${p}). Retrying...`,4e3)}}if(!e.running)return c(`[AUTO-EXTRACT] ‚èπ AutoExtract stopped after capture attempts for page ${a}`),D(`‚èπ AutoExtract stopped. Processed ${e.totalProcessed} pages.`,4e3),B(e),void(o&&(o.textContent="Start AutoExtract"));if(!d&&!g){const t=`‚ùå AutoExtract STOPPED: Page ${a} failed to capture after ${p} attempts.\n\nTotal pages processed: ${e.totalProcessed}`;return alert(t),B(e),void(o&&(o.textContent=`‚ùå Stopped: Page ${a} failed`))}if(g&&(c("‚äò Duplicate detected - will navigate and retry extraction on next page"),y.setMessage("Skipping duplicate, navigating to next...")),!e.running)return c(`‚èπ AutoExtract stopped by user after page ${a}`),D(`‚èπ AutoExtract stopped. Processed ${e.totalProcessed} pages.`,4e3),B(e),void(o&&(o.textContent="Start AutoExtract"));c("\n========================================"),c(`üìÑ Completed page ${a}`),c(`üéØ Now navigating to page ${a+1}...`),c("========================================\n"),c("üîç Step 3: Finding next page button..."),y.setMessage("Finding next page button...");const m=await F(n,e,o);if(!m){const t=`‚ùå AutoExtract STOPPED: Next page button could not be found.\n\nTotal pages processed: ${e.totalProcessed}`;return alert(t),B(e),void(o&&(o.textContent="Start AutoExtract"))}if(!e.running)return c(`‚èπ AutoExtract stopped by user before navigating to page ${a+1}`),D(`‚èπ AutoExtract stopped. Processed ${e.totalProcessed} pages.`,4e3),B(e),void(o&&(o.textContent="Start AutoExtract"));c(`üéØ Now navigating to page ${a+1}...`),y.setMessage(`Navigating to page ${a+1}...`),o&&(o.textContent=`Clicking next button for page ${a+1}...`);const f=window.location.href,h=document.title,b=G(),x=document.querySelector('main, .main-content, [role="main"]'),w=x?x.innerHTML.length:0;await W(m),c("‚úÖ Click executed, waiting for page to navigate..."),c(`‚è≥ Step 5: Waiting for navigation to page ${a+1}...`);if(!await j(f,h,b,w,15e3)){const t=`‚ùå AutoExtract STOPPED: Navigation to page ${a+1} failed.\n\nTotal pages processed: ${e.totalProcessed}`;return alert(t),B(e),void(o&&(o.textContent="‚ùå Stopped: Navigation failed"))}c(`‚úÖ Navigation detected! Page ${a+1} URL loaded.`),c(`‚è≥ Step 6: Waiting for page ${a+1} content to load...`),y.setMessage(`Loading page ${a+1} content...`),o&&(o.textContent=`Loading page ${a+1}...`),await new Promise(e=>setTimeout(e,3e3)),c(`‚è≥ Step 7: Stabilizing page ${a+1}...`),await new Promise(e=>setTimeout(e,1e3)),c(`‚úÖ Page ${a+1} fully loaded and ready for capture!`),c("\n========================================"),c(`üîÑ Looping back to capture page ${a+1}...`),c("========================================\n")}catch(t){c("‚ùå Error in AutoExtract loop:",t);const n=`‚ùå AutoExtract ERROR: ${t.message}\n\nTotal pages processed: ${e.totalProcessed}`;return alert(n),B(e),void(o&&(o.textContent=`‚ùå Error: ${t.message.substring(0,20)}...`))}}}(n,t,e),window.removeEventListener("beforeunload",o),delete window.ServiceNowToNotion.autoExtractState}catch(e){c("‚ùå Auto-extraction failed:",e),y.error({message:`Auto-extraction failed: ${e.message}`}),window.removeEventListener("beforeunload",o),delete window.ServiceNowToNotion.autoExtractState}}(),h.style.display="block",b&&(b.style.display="none")}catch(e){c("Failed to start auto extraction:",e),alert("Error starting auto extraction. Check console for details."),h.style.display="block",b&&(b.style.display="none")}}),b&&(b.onclick=()=>{if(c("üõë Stop button clicked - initiating immediate stop"),window.ServiceNowToNotion&&window.ServiceNowToNotion.autoExtractState){window.ServiceNowToNotion.autoExtractState.running=!1,GM_setValue("w2n_autoExtractState",null),c("üóëÔ∏è Cleared saved autoExtractState"),D("‚èπ Stopping AutoExtract immediately...",3e3);try{window.W2NSavingProgress&&window.W2NSavingProgress.setMessage&&window.W2NSavingProgress.setMessage("‚èπ Stopping...")}catch(e){c("Warning: Could not update overlay message:",e)}h&&(h.textContent="‚èπ Stopping...",h.style.background="#dc2626")}h.style.display="block",b.style.display="none"}),x&&(x.onclick=()=>{try{!function(){const e="function"==typeof GM_getValue?GM_getValue("w2n_next_page_selector","div.zDocsNextTopicButton a"):"div.zDocsNextTopicButton a";let t="AutoExtract Diagnosis:\n\n";if(t+=`Next page selector: ${e||"Not set"}\n\n`,e){t+="‚úÖ Next page selector configured.\n";try{const n=document.querySelector(e);t+=n?`‚úÖ Selector found on current page: ${n.textContent?.trim().substring(0,50)||n.tagName}\n`:"‚ö†Ô∏è Selector not found on current page.\n"}catch(e){t+=`‚ùå Invalid selector: ${e.message}\n`}}else t+="‚ùå No next page selector configured. Use 'Select Next Page Element' first.\n";t+="\nNote: Full auto-extraction functionality is not yet implemented.",alert(t)}()}catch(e){c("Failed to diagnose auto extraction:",e),alert("Error diagnosing auto extraction. Check console for details.")}});try{e.dataset=e.dataset||{},e.dataset.w2nInit="1"}catch(e){}}const q=_;function U(){const e=document.querySelector(".zDocsSubHeaderErrorPage h3.zDocsBreadcrumbsLastItem"),t=document.querySelector(".serverErrorPage.zDocsErrorPage h1");return e&&e.textContent.includes("ERROR 503")?(c("üö® Detected 503 error page"),!0):!(!t||!t.textContent.includes("We'll be back soon"))&&(c('üö® Detected "We\'ll be back soon" error page'),!0)}function O(){const e=document.title,t="Access to this content is limited to authorized users.";if(e===t||e.includes(t))return c(`[ACCESS-LIMITED] üîí Detected access limited page: "${e}"`),!0;const n=document.querySelectorAll("h1");for(const e of n)if(e.textContent&&e.textContent.includes(t))return c(`[ACCESS-LIMITED] üîí Detected access limited message in h1: "${e.textContent}"`),!0;return!1}async function H(e,t){return new Promise(n=>{let o=e;const a=document.createElement("div");a.style.cssText='\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      background: white;\n      border: 2px solid #333;\n      border-radius: 8px;\n      padding: 20px 30px;\n      z-index: 10001;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n      min-width: 300px;\n      text-align: center;\n    ';const r=document.createElement("div");r.style.cssText="margin-bottom: 15px; font-size: 14px; color: #333;",r.textContent=t;const i=document.createElement("div");i.style.cssText="font-size: 24px; font-weight: bold; color: #0066cc;",i.textContent=`${o}s`,a.appendChild(r),a.appendChild(i),document.body.appendChild(a);const s=setInterval(()=>{o--,o>0?i.textContent=`${o}s`:(clearInterval(s),document.body.removeChild(a),n())},1e3)})}async function z(e=15e3){return c("üîÑ Reloading page..."),new Promise(t=>{const n=()=>{c("‚úÖ Page reloaded"),window.removeEventListener("load",n),setTimeout(()=>{U()?(c("‚ùå Page still shows 503 error after reload"),t(!1)):(c("‚úÖ Page loaded successfully without errors"),t(!0))},5e3)};setTimeout(()=>{window.removeEventListener("load",n),c("‚è±Ô∏è Reload timeout reached"),t(!1)},e),window.addEventListener("load",n),window.location.reload()})}async function F(e,t,n){let o=0,a=null;for(;!a&&o<3;)if(o++,n&&(n.textContent=`Looking for next button (${o}/3)...`),a=X(e),!a&&o<3){if(c("[NEXT-BUTTON] ‚ö†Ô∏è Next page button not found, reloading and retrying..."),t){if(t.reloadAttempts=(t.reloadAttempts||0)+1,t.reloadAttempts>3)return c("[STATE-MANAGEMENT] ‚ùå Maximum reload attempts (3) exceeded"),alert(`‚ùå AutoExtract stopped: Maximum reload attempts (3) exceeded.\n\nThe page failed to load properly after 3 reload attempts.\n\nTotal pages processed: ${t.totalProcessed}`),B(t),null;c(`[STATE-MANAGEMENT] üíæ Saving autoExtractState before reload (attempt ${t.reloadAttempts}/3):`,t);const e={...t,processedUrls:Array.from(t.processedUrls||[])},n=JSON.stringify(e);GM_setValue("w2n_autoExtractState",n);c("[STATE-MANAGEMENT] ‚úÖ State save verified: "+(GM_getValue("w2n_autoExtractState")===n?"SUCCESS":"FAILED"))}return c(`[STATE-MANAGEMENT] üîÑ Reloading page to refresh DOM elements (reload attempt ${t.reloadAttempts}/3)...`),await new Promise(e=>setTimeout(e,100)),window.location.reload(),null}return a||(c("‚ùå Next page button not found after 3 attempts with reloads"),alert("‚ùå Next page button could not be found after 3 attempts with page reloads.\n\nAutoExtract has been stopped."),t&&B(t),null)}function G(){return[window.location.hash,window.location.search,document.title,document.querySelector("h1")?.textContent?.trim(),document.querySelector('[class*="page"], [class*="chapter"]')?.textContent?.trim(),document.querySelector("article[id]")?.getAttribute("id"),document.querySelector("[data-page], [data-chapter], [data-section]")?.getAttribute("data-page")||document.querySelector("[data-page], [data-chapter], [data-section]")?.getAttribute("data-chapter")||document.querySelector("[data-page], [data-chapter], [data-section]")?.getAttribute("data-section")].filter(e=>e&&e.length>0).join("|")||Date.now().toString()}function B(e){c("[AUTO-EXTRACT] üõë stopAutoExtract called - cleaning up"),e.running=!1,y.setProgress(100),y.done({success:!0,autoCloseMs:5e3});const t=document.getElementById("w2n-start-autoextract"),n=document.getElementById("w2n-stop-autoextract");t&&(t.style.display="block",t.textContent="Start AutoExtract",t.style.background="#f59e0b"),n&&(n.style.display="none"),GM_setValue("w2n_autoExtractState",null),c("[STATE-MANAGEMENT] üóëÔ∏è Cleared saved autoExtractState in stopAutoExtract"),window.ServiceNowToNotion&&window.ServiceNowToNotion.autoExtractState&&delete window.ServiceNowToNotion.autoExtractState}async function j(e,t,n,o,a=15e3){let r=0;const i=Math.ceil(a/1e3);return new Promise(a=>{const s=()=>{r++;const l=window.location.href,d=document.title,u=G(),p=l!==e,g=d!==t,m=u!==n,f=document.querySelector('main, .main-content, [role="main"]'),h=f?f.innerHTML.length:0,b=f&&h!==o&&h>100;if(r%3==0&&c(`[NAV-VERIFICATION] üîç Navigation check ${r}/${i}:`,{urlChanged:p,titleChanged:g,pageIdChanged:m,contentChanged:b}),p||g||m||b){const e=[];return p&&e.push("URL"),g&&e.push("Title"),m&&e.push("PageID"),b&&e.push("Content"),c(`‚úÖ Navigation detected after ${r} seconds (${e.join(", ")} changed)`),void a(!0)}if(r>=i)return c(`[NAV-VERIFICATION] ‚ùå Navigation timeout after ${i} seconds`),c("[NAV-VERIFICATION] Final state:",{"Original URL":e,"Current URL":l,"Original PageID":n.substring(0,50),"Current PageID":u.substring(0,50)}),void a(!1);setTimeout(s,1e3)};s()})}function V(e){if(!e||!document.contains(e))return!1;const t=window.getComputedStyle(e);if("none"===t.display||"hidden"===t.visibility||"0"===t.opacity)return!1;const n=e.getBoundingClientRect();return(0!==n.width||0!==n.height)&&!e.disabled}async function W(e){try{let t=e;if(e.ownerSVGElement||"use"===e.tagName.toLowerCase()||"path"===e.tagName.toLowerCase()||"svg"===e.tagName.toLowerCase()){c("üîç Element is inside SVG, looking for parent clickable element...");let n=e;for(;n&&n!==document.body;){if("a"===n.tagName.toLowerCase()||"button"===n.tagName.toLowerCase()||"button"===n.getAttribute("role")||n.onclick||n.getAttribute("href")){t=n,c(`[NEXT-BUTTON] ‚úÖ Found parent clickable: ${n.tagName}`);break}n=n.parentElement}}t.focus(),await new Promise(e=>setTimeout(e,100)),t.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0,cancelable:!0})),t.dispatchEvent(new MouseEvent("mouseup",{bubbles:!0,cancelable:!0})),t.click();const n=window.location.href,o=G();setTimeout(()=>{const e=window.location.href,a=G();if(!(e!==n)&&!(a!==o)){c("‚ö†Ô∏è Primary click didn't trigger navigation, trying fallback methods...");try{t.dispatchEvent(new Event("click",{bubbles:!0,cancelable:!0}))}catch(e){c("‚ùå Fallback 1 failed:",e)}try{t.dispatchEvent(new KeyboardEvent("keydown",{key:"Enter",keyCode:13,bubbles:!0,cancelable:!0}))}catch(e){c("‚ùå Fallback 2 failed:",e)}}},1e3)}catch(t){c("Error clicking next page button:",t);const n={message:t.message||"Unknown error",element:e?`${e.tagName}${e.id?"#"+e.id:""}${e.className?"."+e.className.split(" ").join("."):""}`:"null",clickableElement:clickableElement?`${clickableElement.tagName}${clickableElement.id?"#"+clickableElement.id:""}${clickableElement.className?"."+clickableElement.className.split(" ").join("."):""}`:"null",href:clickableElement?.href||"none",onclick:!!clickableElement?.onclick};throw c("Detailed click error info:",n),new Error(`Failed to click next page button: ${t.message||"Unknown error"} (Element: ${n.element}, Clickable: ${n.clickableElement})`)}}function X(e){if(e)try{const t=document.querySelector(e);if(t&&V(t))return c(`üéØ Found next page element with saved selector: ${e}`),t}catch(t){c(`[NEXT-BUTTON] ‚ö†Ô∏è Saved selector failed: ${e}`,t)}const t=["nav",'[role="navigation"]',".pagination",".pager",".navigation","footer",".topic-footer",".page-navigation",".doc-navigation",'[class*="navigation"]','[class*="pager"]'];for(const e of t){const t=document.querySelectorAll(e);for(const n of t){const t=n.querySelectorAll('svg[class*="next" i], svg[class*="forward" i], use[xlink\\:href*="next" i], use[href*="next" i]');for(const n of t){const t=n.closest('a, button, [role="button"]');if(t&&!J(t)&&V(t))return c(`üéØ Found next page element with SVG icon in ${e}: ${n.className}`),t}const o=n.querySelectorAll('a, button, [role="button"]');for(const t of o){if(J(t))continue;if(t.querySelector('svg[class*="next" i], svg[class*="forward" i], use[xlink\\:href*="next" i], use[href*="next" i]')&&V(t))return c(`üéØ Found next page element containing SVG in ${e}`),t;const n=t.textContent?.toLowerCase()||"",o=t.getAttribute("aria-label")?.toLowerCase()||"",a=t.getAttribute("title")?.toLowerCase()||"";if((n.includes("next section")||o.includes("next section")||a.includes("next section")||"next"===n.trim()||n.includes("next")&&(n.includes(">")||n.includes("‚Üí")))&&V(t))return c(`üéØ Found next page element in ${e}: "${n.substring(0,50)}"`),t}}}const n=["svg.ico-next",'svg[class*="next"]','svg[class*="forward"]','use[xlink\\:href*="next"]','use[href*="next"]'];for(const e of n)try{const t=document.querySelectorAll(e);for(const n of t){const t=n.closest('a, button, [role="button"]');if(t&&!J(t)&&V(t))return c(`[NEXT-BUTTON] üéØ Found next page element with SVG selector: ${e}`),t}}catch(e){}const o=['button:contains("Next Section")','a:contains("Next Section")','button:contains("Next")','button:contains("Forward")','button:contains(">")','button:contains("‚Üí")','a:contains("Next")','a:contains("Forward")','a:contains(">")','a:contains("‚Üí")','button[aria-label*="next" i]','button[aria-label*="forward" i]','a[aria-label*="next" i]','a[aria-label*="forward" i]',"button.next","button.forward","a.next","a.forward",".pagination button:last-child",".pagination a:last-child"];for(const e of o)try{let t;if(e.includes(":contains")){const[n,o]=e.split(':contains("'),a=o.slice(0,-2).toLowerCase();t=Array.from(document.querySelectorAll(n)).filter(e=>e.textContent?.toLowerCase().includes(a))}else t=document.querySelectorAll(e);for(const n of t)if(J(n))c(`[NEXT-BUTTON] ‚è≠Ô∏è Skipping current page element: ${n.className}`);else if(V(n))return c(`[NEXT-BUTTON] üîç Found next page element with pattern: ${e}`),n}catch(e){}const a=document.querySelectorAll('button, a, [role="button"]');for(const e of a){if(J(e))continue;const t=e.querySelector("svg, use");if(t){const n=t.className?.baseVal||t.getAttribute("class")||"",o=t.getAttribute("xlink:href")||t.getAttribute("href")||"";if((n.toLowerCase().includes("next")||o.toLowerCase().includes("next"))&&V(e))return c("[NEXT-BUTTON] üéØ Found next page element with SVG child indicator"),e}const n=e.textContent?.trim()||"";if(n.length>50)continue;const o=e.closest('article, main, .content, [role="main"]'),a=e.closest('nav, footer, .navigation, .pagination, [role="navigation"]');if(o&&!a)continue;const r=n.toLowerCase(),i=e.getAttribute("aria-label")?.toLowerCase()||"",s=e.getAttribute("title")?.toLowerCase()||"";if((r.includes("next section")||i.includes("next section")||s.includes("next section")||"next"===r||r.includes("next")&&(r.includes(">")||r.includes("‚Üí")))&&V(e))return c(`üîç Found next page element by text/attribute analysis: "${n.substring(0,30)}"`),e}return c("‚ùå No next page element found with any strategy"),null}function J(e){if(!e)return!1;const t=e.classList||[],n="string"==typeof e.className?e.className:e.className?.baseVal||"",o=["current","active","selected","currentTopic","currentPage","aria-current"];for(const e of o)if(Array.from(t).some(t=>t.toLowerCase().includes(e.toLowerCase()))||n&&n.toLowerCase().includes(e.toLowerCase()))return!0;return"page"===e.getAttribute("aria-current")||"true"===e.getAttribute("aria-current")}_=function(e){q(e);try{e||(e=document.getElementById("w2n-notion-panel")),function(e){const t=e.querySelector("#w2n-header");if(!t)return;let n=!1,o=0,a=0,r=0,i=0;const s=o=>{n&&(n=!1,t.releasePointerCapture&&t.releasePointerCapture(o.pointerId),e.style.transition="")};t.addEventListener("pointerdown",s=>{if(s.button&&0!==s.button)return;if("BUTTON"===s.target.tagName||s.target.closest("button"))return;t.setPointerCapture&&t.setPointerCapture(s.pointerId),n=!0,o=s.clientX,a=s.clientY;const c=e.getBoundingClientRect(),l=window.getComputedStyle(e);if(l.right&&"auto"!==l.right){const e=parseFloat(l.right)||0;r=window.innerWidth-c.width-e}else r=c.left;i=c.top,e.style.left=`${Math.max(8,r)}px`,e.style.right="auto",e.style.transition="none"}),window.addEventListener("pointermove",t=>{if(!n)return;t.preventDefault();const s=t.clientX-o,c=t.clientY-a;let l=r+s,d=i+c;const u=e.getBoundingClientRect();l=Math.min(Math.max(8,l),window.innerWidth-u.width-8),d=Math.min(Math.max(8,d),window.innerHeight-u.height-8+window.scrollY),e.style.left=`${Math.round(l)}px`,e.style.top=`${Math.round(d)}px`}),window.addEventListener("pointerup",s),window.addEventListener("pointercancel",s)}(e)}catch(e){}};const K=["h1",".title","#zDocsContent > header > h1",".page-title",".article-title"],Y=["[class*='version']",".version-info","#zDocsContent > header > ul > li.zDocsTopicPageCluster > div > div > button > div > div > div"],Q=["[class*='updated'], [class*='date']",".last-updated","#zDocsContent > header > ul > li.zDocsTopicPageDate.css-cinqea > span"],Z=[".breadcrumb, [class*='breadcrumb']","nav[aria-label='breadcrumb']","#zDocsTopicPage > div.zDocsTopicPageTopicContainer > div.zDocsTopicPageBreadcrumbsContainer > div"],ee=["[class*='author']",".byline",".created-by",".author-name"],te=["[class*='kb'], [class*='number']",".kb-number",".article-number"],ne=["[class*='category']",".category","#zDocsTopicPage > div.zDocsTopicPageTopicContainer > div.zDocsTopicPageBreadcrumbsContainer > div > span:nth-child(3) > a"],oe=["[class*='section']",".section","#zDocsTopicPage > div.zDocsTopicPageTopicContainer > div.zDocsTopicPageBreadcrumbsContainer > div > span:nth-child(4) > a"],ae=["[class*='status']",".status",".article-status"],re=["[class*='department'], [class*='team']",".department",".team"];function ie(e=[]){for(const t of e)try{const e=document.querySelector(t);if(e&&e.textContent&&e.textContent.trim())return e.textContent.trim()}catch(e){}return""}function se(e,t){const n=s();let o="";try{n&&n[e]&&(o=ie([n[e]])||"")}catch(e){}return o||(Array.isArray(t)?ie(t):ie([t]))}function ce(){c("üîç Extracting ServiceNow metadata...");const e={capturedAt:(new Date).toISOString()};try{e.source="ServiceNow Technical Documentation"}catch(e){}try{const t=se("title",K);let n=se("version",Y);if(!n){const e=window.location.href.match(/\/bundle\/([^\/]+)/);if(e&&e[1]){const t=e[1].match(/^([a-z]+)-/i);t&&(n=t[1].charAt(0).toUpperCase()+t[1].slice(1),c(`üì¶ Extracted version from URL bundle: "${n}"`))}}const o=se("updated",Q);let a="";try{const e=s(),t=e&&e.breadcrumb||Z[0],n=document.querySelector(t);if(n){const e=e=>e?e=(e=(e=e.replace(/\bCurrent page\b/gi,"").trim()).replace(/\bHome\b/gi,"").trim()).replace(/\s{2,}/g," ").replace(/^[>\-‚Äì\s]+|[>\-‚Äì\s]+$/g,""):"",t=Array.from(n.querySelectorAll("a")).map(t=>e(t.textContent||"")).filter(Boolean),o=t.filter((e,n)=>0===n||e.toLowerCase()!==t[n-1].toLowerCase());a=o.length>0?o.join(" > "):e(n.textContent||"")}else a=se("breadcrumb",Z)}catch(e){a=se("breadcrumb",Z)}const r=se("author",ee),i=se("kbNumber",te);let l=se("category",ne);l||(l=se("Catagory",ne)),!l&&t&&(l=t,c(`üìù Category fallback: using title as category: "${l}"`));let d="";const u="#zDocsTopicPage > div.zDocsTopicPageTopicContainer > div.zDocsTopicPageBreadcrumbsContainer > div > span:nth-child(4) > a",p=document.querySelector(u);c(`üîç Section anchor check: selector="${u}", found=${!!p}`),p?(c(`‚úÖ Section anchor found, text: "${p.textContent?.trim()}"`),d=se("section",oe),d||(d=se("Section",oe)),d||(d=p.textContent?.trim()||""),c(`üìù Final sectionText from anchor: "${d}"`)):(c("‚ùå Section anchor not found, using title as section"),d=t,c(`üìù Section set to title: "${d}"`));const g=se("status",ae),m=se("department",re);return t&&(e.title=t),n&&(e.version=n),o&&(e.updated=o),a&&(e.breadcrumb=a),r&&(e.author=r),i&&(e.kbNumber=i),l&&(e.category=l),d&&(e.section=d),g&&(e.status=g),m&&(e.department=m),function(e){try{const t=document.querySelectorAll("img"),n=Array.from(t).filter(e=>{const t=["header","nav","footer",".cmp-header",".cmp-navigation",".cmp-footer",".cmp-banner",".cmp-card",".navbar",".topnav",".sidenav",".breadcrumb",'[class*="header"]','[class*="navigation"]','[class*="footer"]','[class*="banner"]','[class*="promo"]','[class*="marketing"]','[role="banner"]','[role="navigation"]'];for(const n of t)if(e.closest(n))return!1;const n=e.className||"",o=(e.alt||"").toLowerCase(),a=e.getAttribute("src")||"";if(n.includes("logo")||o.includes("logo")||a.includes("logo")||a.includes("snow-logo"))return!1;if(n.includes("emoji")||n.includes("icon")||n.includes("sprite"))return!1;if(e.hasAttribute("data-emoji")||"img"===e.getAttribute("role"))return!1;if(!a||a.startsWith("data:")||a.includes("about:blank")||a.includes("spacer.gif")||a.includes("pixel.gif"))return!1;const r=e.naturalWidth||e.width||0,i=e.naturalHeight||e.height||0;return!(r>0&&r<32&&i>0&&i<32)}),o=document.querySelectorAll("figure"),a=Array.from(o).filter(e=>{const t=["header","nav","footer",".cmp-header",".cmp-navigation",".cmp-footer",".cmp-banner",".cmp-card",".navbar",".topnav",".sidenav",".breadcrumb",'[class*="header"]','[class*="navigation"]','[class*="footer"]','[class*="banner"]','[class*="promo"]','[class*="marketing"]','[role="banner"]','[role="navigation"]'];for(const n of t)if(e.closest(n))return!1;const n=e.querySelectorAll("img");return 0!==n.length&&Array.from(n).some(e=>{const t=e.className||"",n=(e.alt||"").toLowerCase(),o=e.getAttribute("src")||"";if(t.includes("logo")||n.includes("logo")||o.includes("logo")||o.includes("snow-logo"))return!1;if(t.includes("emoji")||t.includes("icon")||t.includes("sprite"))return!1;if(e.hasAttribute("data-emoji")||"img"===e.getAttribute("role"))return!1;if(!o||o.startsWith("data:")||o.includes("about:blank")||o.includes("spacer.gif")||o.includes("pixel.gif"))return!1;const a=e.naturalWidth||e.width||0,r=e.naturalHeight||e.height||0;return!(a>0&&a<32&&r>0&&r<32)})});n.length>0&&(console.log("üñºÔ∏è [W2N] Detected content images:",n.length),n.forEach((e,t)=>{console.log(`  Image ${t+1}:`,{src:e.src?.substring(0,100),width:e.naturalWidth||e.width,height:e.naturalHeight||e.height,className:e.className,alt:e.alt})})),a.length>0&&(console.log("üñºÔ∏è [W2N] Detected figures with images:",a.length),a.forEach((e,t)=>{const n=e.querySelectorAll("img");console.log(`  Figure ${t+1} contains ${n.length} image(s)`)})),e.hasFigureImage=n.length>0||a.length>0;const r=document.querySelectorAll("video"),i=document.querySelectorAll("iframe"),s=e=>{const t=e.getAttribute("src")||"";return[/youtube\.com\/embed\//i,/youtube-nocookie\.com\/embed\//i,/player\.vimeo\.com\//i,/vimeo\.com\/video\//i,/wistia\.(com|net)/i,/fast\.wistia\.(com|net)/i,/loom\.com\/embed\//i,/vidyard\.com\/embed\//i,/brightcove\.(com|net)/i].some(e=>e.test(t))},l=Array.from(i).filter(s);e.hasVideos=r.length>0||l.length>0;try{const t=window.location.href,n=t.match(/\/docs\/bundle\/[^\/]+\/page\/.*\/(.*\.html)/);if(n&&n[1]){const t=n[1];e.CurrentReleaseURL=`https://www.servicenow.com/docs/csh?topicname=${t}&version=latest`}else{const n=document.querySelector('link[rel="canonical"]');e.CurrentReleaseURL=n?n.href:t}}catch(t){e.CurrentReleaseURL=window.location.href}c("üìä Page structure metadata extracted")}catch(e){c("‚ùå Error extracting page structure metadata:",e)}}(e),function(e){try{const t=window.location.href;t.includes("/kb/")||t.includes("/knowledge/")?e.contentType="Knowledge Base Article":t.includes("/docs/")||t.includes("/documentation/")?e.contentType="Documentation":t.includes("/community/")||t.includes("/forum/")?e.contentType="Community Post":e.contentType="ServiceNow Page";document.querySelectorAll('[class*="priority"], [class*="important"], [class*="urgent"]').length>0&&(e.priority="High"),c("üè∑Ô∏è Content type metadata extracted")}catch(e){c("‚ùå Error extracting content type metadata:",e)}}(e),c("‚úÖ ServiceNow metadata extracted:",e),e}catch(t){return c("‚ùå Error extracting ServiceNow metadata:",t),e}}function le(){try{const e=window.location.href.match(/(https?:\/\/[^\/]+\.servicenow\.com)/);return e?e[1]:window.location.origin}catch(e){return c("‚ùå Error constructing ServiceNow base URL:",e),window.location.origin}}async function de(e){console.log("üöÄüöÄüöÄ EXTRACTION STARTED - extractContentWithIframes called"),console.log("   - contentElement tagName:",e?.tagName),console.log("   - contentElement id:",e?.id),console.log("   - contentElement class:",e?.className);let t="",n=[];if(e||(console.log("‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è No content element provided!"),c("‚ö†Ô∏è No content element provided, using document.body as fallback"),e=document.body),e&&"IFRAME"===e.tagName){c(`üìö Extracting content from iframe: ${e.id||"unnamed"}`);let o=e.src;o&&""!==o&&"about:srcdoc"!==o||(o=le(),c(`üìç Constructed ServiceNow base URL: ${o}`));try{await new Promise(e=>setTimeout(e,500));let a=null;try{a=e.contentDocument}catch(e){c(`‚ö†Ô∏è contentDocument access blocked (likely cross-origin): ${e.message}`)}if(!a&&e.contentWindow)try{a=e.contentWindow.document}catch(e){c(`‚ö†Ô∏è contentWindow.document access also blocked: ${e.message}`)}if(!a){const o=e.src||e.getAttribute("src");if(o&&(o.startsWith("http://")||o.startsWith("https://"))){const e=window.location.origin;try{const a=new URL(o,e);if(a.origin!==e)return c(`üö´ Cross-origin iframe detected: ${a.origin} (current: ${e})`),c("‚ÑπÔ∏è Skipping iframe content extraction due to browser security restrictions"),{combinedHtml:t,combinedImages:n}}catch(e){c(`‚ö†Ô∏è Could not parse iframe URL: ${o}`)}}}let r="";if(a){if(console.log("‚úÖ‚úÖ‚úÖ iframeDoc successfully accessed"),console.log("   - iframeDoc.body exists:",!!a.body),console.log("   - iframeDoc.body innerHTML length:",a.body?.innerHTML?.length||0),a.location&&a.location.href&&"about:srcdoc"!==a.location.href){const e=a.location.href;e.includes("/eod/books/")&&(o=e.substring(0,e.lastIndexOf("/")),c(`üìç Found iframe document URL base: ${o}`))}console.log("üîéüîéüîé Starting Strategy 1: Checking bookContentSelectors");const e=[".zDocsTopicPageBody","[role='main'] section","[role='main'] article","main section","main article",".book-text",".chapter-content",".page-content",".content-body","[class*='text'] section","[class*='content'] section","section[class*='text']","article[class*='text']"];for(const t of e){console.log(`   üîç Testing selector: "${t}"`);const e=a.querySelector(t);if(console.log("      - Element found:",!!e),console.log("      - innerHTML length:",e?.innerHTML?.trim().length||0),e?.innerHTML?.trim().length>200){console.log(`   ‚úÖ Selector matched! Using: "${t}"`),r=e.innerHTML;const n=(r.match(/<article[^>]*>/g)||[]).length,o=(r.match(/<h2[^>]*>/g)||[]).length,a=(r.match(/<nav[^>]*>/g)||[]).length;console.log(`üîçüîçüîç EXTRACTION DIAGNOSTIC (${t}):`),console.log(`   - Content length: ${r.length} chars`),console.log(`   - Article tags found: ${n}`),console.log(`   - H2 headings found: ${o}`),console.log(`   - Nav tags found: ${a}`),console.log("   - First 500 chars:",r.substring(0,500)),c(`üìÑ Strategy 1 (${t}): ${r.length} chars, ${n} articles, ${o} h2 headings, ${a} nav elements`);break}}if(!r){const e=a.querySelector("main, [role='main']");if(e){const t=e.cloneNode(!0);t.querySelectorAll("nav, [role='navigation'], .navigation, .breadcrumb, .menu, header, footer").forEach(e=>{e.closest("article, section")||e.remove()}),t.innerHTML?.trim().length>200&&(r=t.innerHTML,c(`üìÑ Strategy 2 (main without nav): ${r.length} chars`))}}if(!r){const e=a.body;e&&(r=e.innerHTML||"",c(`üìÑ Strategy 3 (body.innerHTML fallback): ${r.length} chars`))}if(!r&&a.documentElement&&(r=a.documentElement.innerHTML||"",c(`üìÑ Strategy 4 (documentElement.innerHTML): ${r.length} chars`)),r&&r.trim().length>50){const e=/<table[^>]*>[\s\S]*?<\/table>/gi,i=r.match(e);c(`üîç Found ${i?i.length:0} table(s) in content`);let s=0;r=r.replace(e,(e,t)=>{const n=e.match(/<img[^>]*>/gi),o=e.match(/<svg[^>]*>[\s\S]*?<\/svg>/gi),a=n?n.length:0,r=o?o.length:0;c(`üìã Table at offset ${t}: contains ${a} img tag(s) and ${r} svg element(s)`);let i=e;return o&&(i=i.replace(/<svg[^>]*>[\s\S]*?<\/svg>/gi," ‚Ä¢ "),s+=r,c(`‚úÖ Replaced ${r} svg elements with bullets`)),i}),c(`üìä Total images/svgs replaced in tables: ${s}`),c(s>0?`üîÑ Replaced ${s} images/svgs in tables with bullet symbols (‚Ä¢)`:"‚ö†Ô∏è No images or svgs found in tables to replace"),t=r,c(`‚úÖ Successfully extracted iframe content (${r.length} chars)`);const l=r.substring(0,500);(l.includes("[Invalid Image:")||l.includes("../images/"))&&(c("üìÑ HTML Sample (showing invalid image issue):"),c(`${l}...`));const d=Array.from(a.querySelectorAll("img")).map(e=>{const t=e.src||e.getAttribute("data-src");return c(`üñºÔ∏è Raw img src from iframe: "${t}"`),{url:t,alt:e.alt||e.getAttribute("alt")||"",width:e.width,height:e.height,baseUrl:o}}).filter(e=>e.url);c(`üñºÔ∏è Found ${d.length} images in iframe (base: ${o})`),n.push(...d)}else c("‚ö†Ô∏è No meaningful content extracted from iframe")}else c("‚ö†Ô∏è Cannot access iframe document - likely CORS blocked")}catch(e){c(`‚ùå Error extracting iframe content: ${e.message}`)}}else{c("üìÑ Processing regular content element"),console.log("üìÑüìÑüìÑ Regular content processing - cloning and filtering nav elements");const o=e.cloneNode(!0),a=o.querySelectorAll("nav, [role='navigation'], .navigation, .breadcrumb, .menu, header, footer");console.log(`üìÑ Found ${a.length} navigation elements in regular content`),console.log(`üìÑ contentClone tagName: ${o.tagName}, id: ${o.id}, class: ${o.className}`);let r=0;a.forEach((e,t)=>{const n=e.closest("article"),o=e.closest("section"),a=e.closest("article, section"),i=e.outerHTML?.substring(0,200)||"";console.log(`üìÑ Nav ${t+1}: tagName=${e.tagName}, role=${e.getAttribute("role")}, class=${e.className}`),console.log("   - parentArticle: "+(n?n.tagName+"#"+(n.id||"no-id"):"none")),console.log("   - parentSection: "+(o?o.tagName+"#"+(o.id||"no-id"):"none")),console.log(`   - Preview: ${i}`),a?console.log(`   ‚úÖ Keeping nav: ${e.tagName} (inside article/section)`):(console.log(`   ‚ùå Removing nav: ${e.tagName} (not inside article/section)`),e.remove(),r++)}),console.log(`üìÑ Removed ${r} navigation elements, kept ${a.length-r}`);const i=o.querySelectorAll("iframe");if(i.length>0){c(`üîç Found ${i.length} nested iframes to process`);for(const e of i){const o=await de(e);o.combinedHtml&&(t+=o.combinedHtml,n.push(...o.combinedImages))}}if(!t){t=o.outerHTML||o.innerHTML;const e=(t.match(/<nav[^>]*>/g)||[]).length;console.log(`üìÑ Using filtered content: ${t.length} chars, ${e} nav tags`)}const s=/<table[^>]*>[\s\S]*?<\/table>/gi,l=t.match(s);c(`üîç Found ${l?l.length:0} table(s) in content`);let d=0;t=t.replace(s,(e,t)=>{const n=e.match(/<img[^>]*>/gi),o=e.match(/<svg[^>]*>[\s\S]*?<\/svg>/gi),a=n?n.length:0,r=o?o.length:0;c(`üìã Table at offset ${t}: contains ${a} img tag(s) and ${r} svg element(s)`);let i=e;return o&&(i=i.replace(/<svg[^>]*>[\s\S]*?<\/svg>/gi," ‚Ä¢ "),d+=r,c(`‚úÖ Replaced ${r} svg elements with bullets`)),i}),c(`üìä Total images/svgs replaced in tables: ${d}`),c(d>0?`üîÑ Replaced ${d} images/svgs in tables with bullet symbols (‚Ä¢)`:"‚ö†Ô∏è No images or svgs found in tables to replace");const u=Array.from(e.querySelectorAll("img")).map(e=>({url:e.src||e.getAttribute("data-src"),alt:e.alt||e.getAttribute("alt")||"",width:e.width,height:e.height,baseUrl:le()})).filter(e=>e.url);n.push(...u)}return t=function(e){if(!e||"string"!=typeof e)return"";try{const t=(new DOMParser).parseFromString(e,"text/html"),n=t.querySelectorAll('nav, [role="navigation"]').length;console.log(`üßπ cleanHtmlContent START: ${e.length} chars, ${n} nav elements`);["script","style","meta",'link[rel="stylesheet"]',".advertisement",".ads",".sidebar",".search",'[class*="search"]',".skip-link"].forEach(e=>{const n=t.querySelectorAll(e);n.length>0&&console.log(`üßπ Checking ${n.length} elements matching "${e}"`),n.forEach(t=>{const n=t.closest('nav, [role="navigation"]'),o=t.closest("article, section"),a=t.outerHTML?.length||0;a>200&&console.log(`üîç Large ${t.tagName} (${a} chars): insideNav=${!!n}, insideArticle=${!!o}`),n&&o?console.log(`‚úÖ Preserving ${t.tagName} (${a} chars) inside content nav (selector: ${e})`):(a>200&&console.log(`üßπ Removing large ${t.tagName} (${a} chars) matching "${e}"`),t.remove())})});const o=t.body.innerHTML,a=(o.match(/<nav[^>]*>/g)||[]).length;console.log(`üßπ After removing unwanted: ${o.length} chars, ${a} nav elements`);t.querySelectorAll(".navigation, .breadcrumb, nav, [role='navigation']").forEach(e=>{e.closest("article, section")?console.log(`üßπ cleanHtmlContent: Keeping ${e.tagName}.${e.className} (inside article/section)`):(console.log(`üßπ cleanHtmlContent: Removing ${e.tagName}.${e.className} (not inside article/section)`),e.remove())});const r=t.querySelectorAll("p:empty, div:empty, span:empty");console.log(`üßπ cleanHtmlContent: Found ${r.length} empty elements to remove`),r.forEach(e=>e.remove());const i=t.querySelectorAll("p, div, span");let s=0;i.forEach(e=>{"PRE"===e.tagName||"CODE"===e.tagName||e.querySelector("pre, code")||""===e.textContent.trim()&&0===e.children.length&&(s++,e.remove())}),console.log(`üßπ cleanHtmlContent: Removed ${s} whitespace-only elements`);t.querySelectorAll("img").forEach(e=>{if(e.closest("figure"))return void console.log("üîç Skipping image inside figure:",e.outerHTML.substring(0,150));const t=e.getAttribute("src");(!t||t.includes("data:image/svg+xml")||t.includes("[Invalid Image:"))&&e.remove()}),function(e){try{let t=0;e.querySelectorAll("table, .table, [class*='table']").forEach(e=>{Array.from(e.querySelectorAll("label, .label, [class*='label']")).filter(e=>e.textContent&&e.textContent.includes("Search:")).forEach(e=>{if("Search:"===e.textContent.trim())e.remove(),t++;else{Array.from(e.childNodes).filter(e=>e.nodeType===Node.TEXT_NODE&&e.textContent.includes("Search:")).forEach(e=>e.remove()),t++}})}),c(`‚úÖ Removed ${t} search label(s) from table content`)}catch(e){c("‚ùå Error removing table search labels:",e)}}(t),function(e){try{let t=0;const n=e.querySelectorAll('.code-toolbar, [class*="code-toolbar"], div[class*="code"], pre[class*="code"]');c(`üîç Found ${n.length} potential code elements`),n.forEach((n,o)=>{c(`üîç Processing potential code element ${o+1} (${n.tagName}.${n.className||"no-class"}):`,n.outerHTML.substring(0,300));const a=n.querySelector("pre"),r=n.querySelector("code");c(`üîç Element ${o+1} - Pre element found: ${!!a}, Code element found: ${!!r}`);const i="PRE"===n.tagName,s="CODE"===n.tagName;if(i||s){if(c(`üîç Element ${o+1} is already a ${n.tagName}, checking language`),!n.className||!n.className.includes("language-")){const e=n.textContent||n.innerText||"";(e.includes("var ")||e.includes("function ")||e.includes("Class.create")||e.includes("Object.extendsObject")||e.includes("prototype =")||e.includes("= Class.create")||e.includes(".prototype"))&&(n.className="language-javascript",n.setAttribute("data-language","javascript"),c(`‚úÖ Added language-javascript class to existing ${n.tagName} element ${o+1}`))}const e=n.parentNode;return e&&["DIV","P","SECTION","ARTICLE"].includes(e.tagName)&&(c(`üîç Moving nested pre element ${o+1} to top level`),e.parentNode.insertBefore(n,e.nextSibling)),void t++}if(a&&r){const o=r.textContent||r.innerText||"";let a="";const i=(r.className||"").match(/language-(\w+)/);i&&(a=i[1]),a&&"plaintext"!==a&&"text"!==a||(o.includes("var ")||o.includes("function ")||o.includes("Class.create")||o.includes("Object.extendsObject")||o.includes("prototype =")||o.includes("= Class.create")||o.includes(".prototype"))&&(a="javascript",c(`üîç Detected JavaScript-like code, overriding language to: ${a}`));const s=e.createElement("pre");a&&(s.className=`language-${a}`,s.setAttribute("data-language",a)),s.textContent=o;const l=n.parentNode;l&&["DIV","P","SECTION","ARTICLE"].includes(l.tagName)?(l.parentNode.insertBefore(s,l.nextSibling),n.remove()):l.replaceChild(s,n),t++,c(`‚úÖ Processed code-toolbar element with ${a||"no"} language, ${o.length} chars: ${o.substring(0,100)}`)}else if(a){c("üîç Found pre element without code wrapper, processing anyway");const o=a.textContent||a.innerText||"";let r="";const i=(a.className||"").match(/language-(\w+)/);i&&(r=i[1]),r&&"plaintext"!==r&&"text"!==r||(o.includes("var ")||o.includes("function ")||o.includes("Class.create")||o.includes("Object.extendsObject")||o.includes("prototype =")||o.includes("= Class.create")||o.includes(".prototype"))&&(r="javascript",c(`üîç Detected JavaScript-like code in pre element, overriding language to: ${r}`));const s=e.createElement("pre");r&&(s.className=`language-${r}`,s.setAttribute("data-language",r)),s.textContent=o;const l=n.parentNode;l&&["DIV","P","SECTION","ARTICLE"].includes(l.tagName)?(l.parentNode.insertBefore(s,l.nextSibling),n.remove()):l.replaceChild(s,n),t++,c(`‚úÖ Processed pre element with ${r||"no"} language, ${o.length} chars`)}else c(`‚ùå Code element ${o+1} missing pre or code child elements`)});const o=e.querySelectorAll("pre");c(`üîç Found ${o.length} total pre elements in document`),o.forEach((e,t)=>{const n=e.parentElement;c(`üîç Pre element ${t+1} ${n&&(n.classList.contains("code-toolbar")||n.matches('[class*="code-toolbar"]'))?"(in code-toolbar)":"(not in code-toolbar)"}:`,e.outerHTML.substring(0,200));{const n=e.textContent||e.innerText||"";(n.includes("var ")||n.includes("function ")||n.includes("Class.create")||n.includes("Object.extendsObject")||n.includes("prototype =")||n.includes("= Class.create")||n.includes(".prototype"))&&(c(`üîç Pre element ${t+1} contains JavaScript-like code, ensuring it's properly formatted`),e.className&&e.className.includes("language-")&&!e.className.includes("language-plaintext")||(e.className="language-javascript",e.setAttribute("data-language","javascript"),c(`‚úÖ Added language-javascript class to pre element ${t+1}`)))}}),c(t>0?`‚úÖ Processed ${t} code element(s) as code blocks`:"‚ö†Ô∏è No code elements were processed")}catch(e){c("‚ùå Error processing code elements:",e)}}(t);const l=t.body.innerHTML,d=(l.match(/<nav[^>]*>/g)||[]).length;return console.log(`üßπ cleanHtmlContent END: ${l.length} chars, ${d} nav elements`),c("‚úÖ HTML content cleaned successfully"),l}catch(t){return c("‚ùå Error cleaning HTML content:",t),e}}(t),{combinedHtml:t,combinedImages:n}}function ue(e){return e&&"string"==typeof e?e.replace(/\s+/g," ").replace(/^\s+|\s+$/g,"").replace(/\n\s*\n/g,"\n").trim():""}function pe(e){try{if(!e)return"";let t=e;if("string"==typeof e){const n=document.createElement("div");n.innerHTML=e,t=n}if(!t||"function"!=typeof t.querySelectorAll)return"";return t.querySelectorAll("script, style, meta, link").forEach(e=>e.remove()),ue(t.textContent||t.innerText||"")}catch(e){return c("‚ùå Error extracting plain text:",e),""}}function ge(e){return e&&"string"==typeof e?e.trim().split(/\s+/).filter(e=>e.length>0).length:0}function me(e){try{if(!e)return[];let t=e;if("string"==typeof e){const n=document.createElement("div");n.innerHTML=e,t=n}if(!t||!t.children)return[];const n=[],o=Array.from(t.children);let a=null;return o.forEach(e=>{["H1","H2","H3","H4","H5","H6"].includes(e.tagName)?(a&&n.push(a),a={heading:{level:parseInt(e.tagName.substring(1)),text:ue(e.textContent||""),tagName:e.tagName.toLowerCase()},content:[]}):a?a.content.push(e.outerHTML):(n.length&&!n[0].heading||n.unshift({heading:null,content:[]}),n[0].content.push(e.outerHTML))}),a&&n.push(a),n.map(e=>({...e,content:e.content.join("\n"),wordCount:ge(pe(e.content.join("\n")))}))}catch(e){return c("‚ùå Error splitting content into sections:",e),[]}}function fe(e){try{if(!e)return{wordCount:0,readingTime:0,characterCount:0,headingCount:0,imageCount:0,linkCount:0,tableCount:0,listCount:0,text:"",outline:[]};const t=pe(e),n=ge(t),o=function(e,t=200){const n=ge(e);return Math.ceil(n/t)}(t),a=function(e){try{let t=e;if("string"==typeof e){const n=document.createElement("div");n.innerHTML=e,t=n}return Array.from(t.querySelectorAll("h1, h2, h3, h4, h5, h6")).map((e,t)=>({level:parseInt(e.tagName.substring(1)),text:ue(e.textContent||""),id:e.id||`heading-${t}`,tagName:e.tagName.toLowerCase()}))}catch(e){return c("‚ùå Error extracting content outline:",e),[]}}(e);let r=e;if("string"==typeof e){const t=document.createElement("div");t.innerHTML=e,r=t}if(!r||"function"!=typeof r.querySelectorAll)return{wordCount:n,readingTime:o,characterCount:t.length,headingCount:a.length,imageCount:0,linkCount:0,tableCount:0,listCount:0,text:t,outline:a};const i=r.querySelectorAll("img").length,s=r.querySelectorAll("a[href]").length,l=r.querySelectorAll("table").length,d=r.querySelectorAll("ul, ol").length;return{wordCount:n,readingTime:o,characterCount:t.length,headingCount:a.length,imageCount:i,linkCount:s,tableCount:l,listCount:d,outline:a}}catch(e){return c("‚ùå Error analyzing content:",e),{wordCount:0,readingTime:0,characterCount:0,headingCount:0,imageCount:0,linkCount:0,tableCount:0,listCount:0,outline:[]}}}class he{constructor(){this.config=null,this.isProcessing=!1,this.currentExtractedData=null,this.workflowAvailable=!1}async initialize(){c(`üöÄ ServiceNow-2-Notion v${e} initializing...`);try{this.config=await l(),this.workflowAvailable=!1,await this.initializeUI(),c("‚úÖ Application initialized successfully")}catch(e){throw c("‚ùå Failed to initialize application:",e),e}}async initializeUI(){c("üé® Initializing UI components");try{try{const e=new Set(["w2n-notion-panel","w2n-header","w2n-close","w2n-database-select","w2n-selected-database-label","w2n-refresh-dbs","w2n-search-dbs","w2n-get-db","w2n-configure-mapping","w2n-capture-page","w2n-capture-description","w2n-max-pages","w2n-autoextract-controls","w2n-start-autoextract","w2n-open-icon-cover","w2n-diagnose-autoextract","w2n-advanced-settings-modal","w2n-icon-cover-modal","w2n-property-mapping-modal","w2n-saving-progress","w2n-mapping-db-name","w2n-property-mappings","w2n-modal-use-martian","w2n-modal-direct-images","w2n-modal-debug-mode","w2n-modal-duplicate-detect"]),t=["w2n-progress-","w2n-unsplash-"];["W2N-save-button","W2N-settings-button","W2N-button-container"].forEach(e=>{const t=document.getElementById(e);t&&t.remove&&t.remove()}),Array.from(document.querySelectorAll("[id^='w2n-']")).forEach(n=>{const o=n.id;e.has(o)||t.some(e=>o.startsWith(e))||(c(`Removing stale DOM element with id=${o}`),n&&n.remove&&n.remove())});["w2n-indicator-martian"].forEach(e=>{const t=document.getElementById(e);t&&t.remove&&t.remove()})}catch(e){c("Failed to cleanup old UI elements:",e)}try{h(L)}catch(e){c("Failed to set overlay property mapping injector:",e)}try{!function(){if(document.getElementById("w2n-notion-panel"))return;const e=i(),t=document.createElement("div");t.id="w2n-notion-panel",t.style.cssText="\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    width: 320px;\n    background: white;\n    border: 1px solid #e5e7eb;\n    border-radius: 8px;\n    box-shadow: 0 10px 25px rgba(0,0,0,0.15);\n    z-index: 10000;\n    font-family: system-ui, -apple-system, sans-serif;\n    font-size: 14px;\n    user-select: none;\n    opacity: 0.95;\n    transition: opacity 0.2s ease;\n  ",t.addEventListener("mouseenter",()=>t.style.opacity="1"),t.addEventListener("mouseleave",()=>t.style.opacity="0.95"),t.innerHTML=`\n    <style>\n      @keyframes spin {\n        0% { transform: rotate(0deg); }\n        100% { transform: rotate(360deg); }\n      }\n    </style>\n    <div id="w2n-header" style="padding: 16px; border-bottom: 1px solid #e5e7eb; background: #f9fafb; border-radius: 8px 8px 0 0; cursor: move; position: relative;">\n      <div style="display:flex; justify-content:space-between; align-items:center;">\n        <h3 style="margin:0; font-size:16px; color:#1f2937; display:flex; align-items:center; gap:8px;">\n          üìö ServiceNow to Notion\n          <span style="font-size:12px; color:#6b7280; font-weight:normal;">‚áÑ drag to move</span>\n        </h3>\n        <div style="display:flex; align-items:center; gap:8px;">\n          <button id="w2n-advanced-settings-btn" title="Advanced Settings" style="background:none;border:none;font-size:16px;cursor:pointer;color:#6b7280;padding:4px;line-height:1;">‚öôÔ∏è</button>\n          <button id="w2n-close" style="background:none;border:none;font-size:18px;cursor:pointer;color:#6b7280;padding:4px;line-height:1;">√ó</button>\n        </div>\n      </div>\n    </div>\n\n    <div style="padding:16px;">\n      <div style="margin-bottom:16px;">\n        <label style="display:block;margin-bottom:5px;font-weight:500;">Database:</label>\n        <select id="w2n-database-select" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;">\n          <option value="${e.databaseId||""}">${e.databaseName||"(no database)"}</option>\n        </select>\n        <div id="w2n-selected-database-label" style="margin-top:8px;font-size:12px;color:#6b7280;">Database: ${e.databaseName||"(no database)"}</div>\n        <div style="margin-top:8px; display:flex; gap:6px; align-items:center; flex-wrap:wrap;">\n          <button id="w2n-refresh-dbs" style="font-size:11px;padding:4px 6px;border:1px solid #d1d5db;border-radius:4px;background:white;cursor:pointer;">Refresh</button>\n          <button id="w2n-search-dbs" style="font-size:11px;padding:4px 6px;border:1px solid #d1d5db;border-radius:4px;background:white;cursor:pointer;">Search</button>\n          <button id="w2n-get-db" style="font-size:11px;padding:4px 6px;border:1px solid #d1d5db;border-radius:4px;background:white;cursor:pointer;">By ID</button>\n          <button id="w2n-configure-mapping" style="font-size:11px;padding:6px 8px;border:1px solid #10b981;border-radius:4px;background:#10b981;color:white;cursor:pointer;">Configure Property Mapping</button>\n        </div>\n        <div id="w2n-db-spinner" style="display:none; margin-top:8px; font-size:12px; color:#6b7280; align-items:center;">\n          <span style="display:inline-block; width:12px; height:12px; border:2px solid #d1d5db; border-top:2px solid #10b981; border-radius:50%; animation:spin 1s linear infinite; margin-right:8px;"></span>\n          Fetching databases...\n        </div>\n      </div>\n\n      <div style="display:grid; gap:8px; margin-bottom:16px;">\n        <button id="w2n-capture-page" style="width:100%; padding:12px; background:#10b981; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:500;">üìÑ Save Current Page</button>\n        <button id="w2n-capture-description" style="width:100%; padding:12px; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:500;">üìñ Download PDF</button>\n      </div>\n\n      <div style="border-top:1px solid #e5e7eb; padding-top:16px;">\n        <div style="display:flex; align-items:center; margin-bottom:12px;">\n          <span style="font-size:16px; margin-right:8px;">ü§ñ</span>\n          <h4 style="margin:0; font-size:14px; font-weight:500;">AutoExtract Multi-Page</h4>\n        </div>\n\n        <div id="w2n-autoextract-controls">\n          <div style="display:flex; gap:8px;">\n            <button id="w2n-start-autoextract" style="flex:1; padding:10px; background:#f59e0b; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:500;">Start AutoExtract</button>\n            <button id="w2n-stop-autoextract" style="flex:1; padding:10px; background:#dc2626; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:500; display:none;">‚èπ Stop</button>\n          </div>\n          <div style="display:flex; gap:8px; margin-top:8px;">\n            <button id="w2n-open-icon-cover" style="flex:1; padding:8px; background:#6b7280; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px;">Icon & Cover</button>\n            <button id="w2n-diagnose-autoextract" style="flex:1; padding:8px; background:#0ea5e9; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px;">üîç Diagnose</button>\n          </div>\n        </div>\n      </div>\n    </div>\n  `,document.body.appendChild(t),_(t)}()}catch(e){c("Failed to inject main panel:",e)}this.createMainActionButton(),this.createSettingsButton(),c("‚úÖ UI components initialized")}catch(e){throw c("‚ùå Failed to initialize UI:",e),e}}createMainActionButton(){if(document.getElementById("w2n-notion-panel"))return void c("‚ÑπÔ∏è Floating panel detected, skipping main action button creation");const t=this.findButtonContainer();if(!t)return void c("‚ö†Ô∏è Could not find suitable container for main button");const a=I("button",{id:"W2N-save-button",title:`ServiceNow-2-Notion v${e} - Save current page to Notion`,style:`\n        background-color: ${n};\n        color: white;\n        border: none;\n        border-radius: 6px;\n        padding: 8px 16px;\n        font-size: 14px;\n        font-weight: bold;\n        cursor: pointer;\n        margin-left: 10px;\n        display: inline-flex;\n        align-items: center;\n        gap: 6px;\n        transition: all 0.2s ease;\n      `},"üíæ Save to Notion");a.addEventListener("click",()=>this.handleMainAction()),a.addEventListener("mouseenter",()=>{a.style.backgroundColor=o,a.style.transform="translateY(-1px)"}),a.addEventListener("mouseleave",()=>{a.style.backgroundColor=n,a.style.transform="translateY(0)"}),t.appendChild(a),c("‚úÖ Main action button created")}createSettingsButton(){if(document.getElementById("w2n-notion-panel"))return void c("‚ÑπÔ∏è Floating panel detected, skipping settings button creation");const e=this.findButtonContainer();if(!e)return;const t=I("button",{id:"W2N-settings-button",title:"ServiceNow-2-Notion Settings",style:"\n        background-color: #6b7280;\n        color: white;\n        border: none;\n        border-radius: 6px;\n        padding: 8px 12px;\n        font-size: 14px;\n        cursor: pointer;\n        margin-left: 5px;\n        display: inline-flex;\n        align-items: center;\n        transition: all 0.2s ease;\n      "},"‚öôÔ∏è");t.addEventListener("click",()=>this.showSettingsModal()),t.addEventListener("mouseenter",()=>{t.style.backgroundColor="#4b5563"}),t.addEventListener("mouseleave",()=>{t.style.backgroundColor="#6b7280"}),e.appendChild(t),c("‚úÖ Settings button created")}findButtonContainer(){const e=[".sn-polaris-nav .sn-action-buttons",".sn-polaris-header .action-bar",".sn-polaris-toolbar",".sn-polaris-nav",".header-actions",".action-bar",".button-bar",".nav-actions",".navbar-right",".toolbar","#gsft_main",".content-header",".page-header .actions",".main-header",".cmp-nav__wrapper","nav.cmp-nav","header .actions",".navbar .actions","nav","header"];for(const t of e){const e=document.querySelector(t);if(e)return c(`‚úÖ Found button container: ${t}`),e}c("üîç No matching container found. Available page structure:"),c("  - Header elements:",document.querySelectorAll("header").length),c("  - Nav elements:",document.querySelectorAll("nav").length),c("  - Toolbar elements:",document.querySelectorAll('[class*="toolbar"]').length),c("  - Action elements:",document.querySelectorAll('[class*="action"]').length),c("  - Polaris elements:",document.querySelectorAll('[class*="polaris"]').length);const t=document.querySelectorAll("body > *");return t.length>0&&c("  - Top-level containers:",Array.from(t).slice(0,5).map(e=>e.className||e.tagName).join(", ")),null}async handleMainAction(){if(this.isProcessing)c("‚ö†Ô∏è Already processing, ignoring click");else{this.isProcessing=!0;try{y.start("Starting extraction..."),y.setMessage("Extracting page metadata...");const e=await this.extractCurrentPageData();this.currentExtractedData=e,y.setMessage("Preparing content for Notion..."),await this.processWithProxy(e)}catch(e){c("‚ùå Main action failed:",e);try{y.error({message:`Failed to save to Notion: ${e.message}`})}catch(e){try{y.close&&y.close()}catch(e){}}!function(e){D(`‚ùå Error: ${e||"Unknown error occurred"}`,5e3)}("Failed to save to Notion: "+e.message)}finally{this.isProcessing=!1}}}async extractCurrentPageData(){c("üìù Extracting current page data");try{y.setMessage("Reading page title and properties...");const e=ce();y.setMessage("Locating content elements...");const t=function(){console.log("üöÄ ServiceNow-2-Notion - Finding content element (prioritizing .zDocsTopicPageBody, excluding header)"),c("üîç Searching for content element...");const e=["#zDocsContent > div.zDocsTopicPageBody",".zDocsTopicPageBody","#zDocsContent .zDocsTopicPageBody","main[role='main']","main","[role='main']",".main-content",".content-main","#main-content","#content",".content","article",".article-body",".article-content",".post-content",".entry-content",".book-content",".documentation",".docs-content",".container-main","#container",".wrapper-main"];for(const t of e)try{const e=document.querySelector(t);if(e&&e.innerHTML&&e.innerHTML.trim().length>100){if(c(`‚úÖ Found content element using selector: ${t}`),c(`üìè Content length: ${e.innerHTML.length} characters`),t.includes("zDocsTopicPageBody")){const t=e.closest("#zDocsContent");if(t){const n=t.querySelector(":scope > header");n&&e.contains(n)?c("‚ö†Ô∏è Element contains header, this shouldn't happen with direct child selector"):c("‚úÖ Confirmed: Element excludes #zDocsContent > header (as expected)")}}return e}}catch(e){c(`‚ùå Invalid selector: ${t}`)}const t=["[id*='customize-script-includes']","section[id]","div[id]"];for(const e of t)try{const t=document.querySelectorAll(e);for(const n of t)if(n&&n.innerHTML&&n.innerHTML.trim().length>100)return c(`‚úÖ Found content section using selector: ${e} (id: ${n.id})`),c(`üìè Section content length: ${n.innerHTML.length} characters`),n}catch(t){c(`‚ùå Invalid section selector: ${e}`)}return c("‚ùå No suitable content element found"),null}();y.setMessage("Extracting content from page...");const n=await de(t),o=(n.combinedHtml?.match(/<nav[^>]*>/g)||[]).length,a=(n.combinedHtml?.match(/<ol[^>]*>/g)||[]).length,r=(n.combinedHtml?.match(/<li[^>]*>/g)||[]).length,i=n.combinedHtml?.match(/<ol[^>]*class="[^"]*ol steps[^"]*"[^>]*>/);if(console.log(`üîç AFTER EXTRACTION: combinedHtml=${n.combinedHtml?.length} chars, ${o} nav tags`),console.log(`üîç EXTRACTION CONTENT CHECK: ${a} OL tags, ${r} LI tags`),console.log(`üîç Main steps OL found: ${!!i}`),i){const e=n.combinedHtml.indexOf(i[0]),t=n.combinedHtml.indexOf("</ol>",e),o=(n.combinedHtml.substring(e,t+5).match(/<li[^>]*class="[^"]*li step[^"]*"[^>]*>/g)||[]).length;console.log(`üîç Main steps OL: ${o} direct LI children (should be 6)`)}y.setMessage("Analyzing content structure...");const s=n.html?fe(n.html):{},l={...e,content:{...n,...s,sections:n.html?me(n.html):[]},timestamp:(new Date).toISOString()};return c("‚úÖ Page data extracted successfully"),l}catch(e){throw c("‚ùå Failed to extract page data:",e),e}}async processWithWorkflow(e){return c("processWithWorkflow is deprecated; redirecting to proxy processing"),this.processWithProxy(e)}async processWithProxy(e){c("üîÑ Processing with proxy server");try{y.setMessage("Checking proxy connection...");const t=this.config||i();"undefined"!=typeof GM_xmlhttpRequest||y.error({message:"This userscript is running without privileged XHR (GM_xmlhttpRequest).\nBrowser fetch will be blocked by CORS for the proxy.\nPlease run the userscript in Tampermonkey (grant GM_xmlhttpRequest),\nor configure the proxy to allow CORS from this origin.",retryCallback:async()=>{y.setMessage("Re-checking proxy connection...");try{const e=await async function(){c("üèì Pinging proxy server");try{const e=await v("GET","/api/ping");let t=!1;return e&&((e.pong||"ok"===e.status)&&(t=!0),e.success&&e.data&&(e.data.pong||"ok"===e.data.status)&&(t=!0)),c(t?"‚úÖ Proxy ping successful":"‚ùå Proxy ping failed"),t}catch(e){return c("‚ùå Proxy ping error:",e),!1}}();if(!e)throw y.error({message:"Proxy still unreachable from this context.\nEither enable GM_xmlhttpRequest or run from a browser extension that allows cross-origin requests."}),new Error("Proxy unreachable");y.setMessage("Proxy reachable ‚Äî continuing...")}catch(e){throw y.error({message:"Error while re-checking proxy: "+(e.message||e)}),e}}});if(!(await T()).healthy)throw y.error({message:`Proxy server is not available (${t.proxyUrl||"unknown"})`,retryCallback:async()=>{try{y.setMessage("Re-checking proxy connection...");if((await T()).healthy){y.setMessage("Proxy available ‚Äî continuing...");try{await this.processWithProxy(e)}catch(e){c("Retry processing failed:",e),y.error({message:"Processing failed after proxy became available"})}}else y.error({message:"Proxy still unavailable. Check proxy server and network settings."})}catch(e){y.error({message:"Error while re-checking proxy: "+(e.message||e)})}}}),new Error("Proxy server is not available");const n=i();if(!n.databaseId)return void await this.showDatabaseSelection();y.setMessage("Fetching database schema...");const o=await $(n.databaseId);y.setMessage("Loading property mappings...");const a=await async function(e){const t=`w2n_property_mappings_${e}`;return new Promise(e=>{if("function"==typeof GM_getValue)try{const n=GM_getValue(t,"{}");c(`üîç Loading mappings with key: ${t}`),c(`üîç Raw saved value: ${n}`);const o=JSON.parse(n);c(`‚úÖ Retrieved property mappings (${Object.keys(o).length} mappings):`,o),e(o)}catch(t){c("‚ùå Failed to parse property mappings:",t),e({})}else c("‚ö†Ô∏è GM_getValue not available"),e({})})}(n.databaseId);y.setMessage("Mapping properties to Notion format...");const r=P(e,o,a);y.setMessage("Formatting page content...");const s=e.content?.combinedHtml||e.contentHtml||"";console.log("üîçüîçüîç MAIN.JS - HTML content length:",s.length);const l=(s.match(/<section[^>]*id="predictive-intelligence-for-incident__section_/g)||[]).length;console.log("üîçüîçüîç MAIN.JS - Sections in HTML:",l),console.log("üîçüîçüîç MAIN.JS - First 500 chars:",s.substring(0,500)),console.log("üîçüîçüîç MAIN.JS - Last 500 chars:",s.substring(s.length-500));const d=(s.match(/<ol[^>]*>/g)||[]).length,u=(s.match(/<li[^>]*>/g)||[]).length,p=s.match(/<ol[^>]*class="[^"]*ol steps[^"]*"[^>]*>/);if(console.log(`üîçüîçüîç MAIN.JS - About to send to server: ${d} OL tags, ${u} LI tags`),p){const e=s.indexOf(p[0]);let t=1,n=e+p[0].length;for(;t>0&&n<s.length;){const e=s.indexOf("<ol",n),o=s.indexOf("</ol>",n);if(-1===o)break;-1!==e&&e<o?(t++,n=e+3):(t--,n=o+5)}const o=(s.substring(e,n).match(/<li[^>]*class="[^"]*li step[^"]*"[^>]*>/g)||[]).length;console.log(`üîçüîçüîç MAIN.JS - Main steps OL being sent has ${o} direct LI children (should be 6)`)}const g={title:e.title||document.title||"Untitled Page",content:s,contentHtml:s,databaseId:n.databaseId,url:window.location.href,properties:r};e.icon&&(g.icon=e.icon),e.cover&&(g.cover=e.cover);let m=null;if(n.enableDuplicateDetection){if(g.title&&g.title.trim().length>0||g.url&&g.url.trim().length>0){y.setMessage("Checking for duplicates...");try{m=await this.findDuplicatePages(o,g)}catch(e){c("Duplicate detection failed:",e),D("Duplicate check failed. Continuing with Notion save.",4e3)}}}if(m&&m.duplicates&&m.duplicates.length>0){const e=function(e){if(!Array.isArray(e)||0===e.length)return"";return e.map((e,t)=>{const n=e?.page?.title||"Untitled",o=e?.page?.url,a=Array.isArray(e?.reasons)?e.reasons.filter(Boolean):[];return`${t+1}. ${n}${a.length>0?` ‚Äî ${a.join(", ")}`:""}${o?`\n   ${o}`:""}`}).join("\n")}(m.duplicates,m.titlePropertyName),t=function(e){if(!Array.isArray(e)||0===e.length)return"Title";const t=e.map(e=>"string"==typeof e?e.trim():"").filter(Boolean);if(0===t.length)return"Title";if(1===t.length)return t[0];if(2===t.length)return`${t[0]} or ${t[1]}`;const n=t.pop();return`${t.join(", ")}, or ${n}`}(m.reasonLabels),n=`Found ${m.duplicates.length} Notion page${m.duplicates.length>1?"s":""} matching by ${t}.`+(e?`\n\n${e}`:"")+"\n\nPress OK to create a new page anyway, or Cancel to open the first match.";if(!window.confirm(n)){y.close&&y.close();const e=m.duplicates.find(e=>e.page&&e.page.url);return e&&e.page.url&&window.open(e.page.url,"_blank"),void D("Skipped creating a new Notion page because a duplicate exists.",5e3)}D("Duplicate detected. Creating a new Notion page anyway.",4e3)}y.setMessage("Saving to Notion..."),console.log("üîç [CLIENT-DEBUG] pageData.contentHtml exists?",!!g.contentHtml),console.log("üîç [CLIENT-DEBUG] pageData.contentHtml length:",g.contentHtml?g.contentHtml.length:0);const f=g.contentHtml&&g.contentHtml.includes("devops-software-quality-sub-category__ol_bpk_gfk_xpb");if(console.log("üîç [CLIENT-DEBUG] Has target OL ID?",f),g.contentHtml){window.DEBUG_LAST_EXPORT_HTML=g.contentHtml,console.log("üíæ [CLIENT-DEBUG] Saved full export HTML to window.DEBUG_LAST_EXPORT_HTML"),console.log("üíæ [CLIENT-DEBUG] HTML length:",g.contentHtml.length);const e=g.contentHtml.match(/<ol[^>]*id="devops-software-quality-sub-category__ol_bpk_gfk_xpb"[^>]*>[\s\S]*?<\/ol>/);if(e){window.DEBUG_TARGET_OL=e[0],console.log("üíæ [CLIENT-DEBUG] ‚úÖ Extracted target OL to window.DEBUG_TARGET_OL"),console.log("üíæ [CLIENT-DEBUG] OL length:",window.DEBUG_TARGET_OL.length),console.log("üíæ [CLIENT-DEBUG] Contains Submit span:",window.DEBUG_TARGET_OL.includes('<span class="ph uicontrol">Submit</span>'));const t=(window.DEBUG_TARGET_OL.match(/<li/g)||[]).length;console.log("üíæ [CLIENT-DEBUG] Total <li> tags in OL:",t);try{const e=document.createElement("div");e.innerHTML=window.DEBUG_TARGET_OL;const t=e.querySelector("ol");if(t){const e=Array.from(t.children).filter(e=>"LI"===e.tagName);if(console.log("üíæ [CLIENT-DEBUG] Parsed",e.length,"direct <li> children from OL"),e.length>=4){const t=e[3];console.log("üíæ [CLIENT-DEBUG] 4th LI text:",t.textContent.substring(0,100).trim()),console.log("üíæ [CLIENT-DEBUG] 4th LI HTML:",t.outerHTML.substring(0,300))}else console.log("‚ö†Ô∏è [CLIENT-DEBUG] Only found",e.length,"direct LI children (expected 4)")}}catch(e){console.log("‚ö†Ô∏è [CLIENT-DEBUG] Failed to parse OL:",e.message)}}else{console.log("‚ö†Ô∏è [CLIENT-DEBUG] Target OL not found in extracted HTML");const e=g.contentHtml.match(/<ol[^>]*id="([^"]*)"[^>]*>/g);e&&console.log("‚ö†Ô∏è [CLIENT-DEBUG] Found these OL IDs:",e.map(e=>e.match(/id="([^"]*)"/)[1]).join(", "))}}else console.log("‚ùå [CLIENT-DEBUG] pageData.contentHtml is empty or undefined!");if(c("üîç DEBUG: pageData structure being sent to proxy:",{title:g.title,contentLength:g.content?g.content.length:0,contentHtmlLength:g.contentHtml?g.contentHtml.length:0,hasContent:!!g.content,hasContentHtml:!!g.contentHtml,contentPreview:g.content?g.content.substring(0,100):"EMPTY",contentHtmlPreview:g.contentHtml?g.contentHtml.substring(0,100):"EMPTY"}),g.contentHtml){const e=(g.contentHtml.match(/class="topic task nested1"/g)||[]).length;if(console.log("üö®üö®üö® CLIENT SENDING:",e,"article.nested1 elements"),console.log("   pageData.contentHtml length:",g.contentHtml.length),console.log("   pageData.content length:",g.content?g.content.length:0),console.log("   Are they the same?",g.contentHtml===g.content),console.log("üîç [CLIENT-DEBUG] Checking for 4th list item in contentHtml:"),console.log("   Contains 'Click Submit':",g.contentHtml.includes("Click Submit")),console.log("   Contains 'successfully created':",g.contentHtml.includes("successfully created")),console.log("   Number of <li tags:",(g.contentHtml.match(/<li/g)||[]).length),g.contentHtml.includes("Software Quality Sub Categories")){const e=g.contentHtml.match(/<ol[^>]*id="devops-software-quality-sub-category__ol_bpk_gfk_xpb"[^>]*>[\s\S]*?<\/ol>/);if(e){const t=e[0],n=(t.match(/<li/g)||[]).length;console.log("   Found target <ol>, contains",n,"<li> tags"),console.log("   OL contains 'Click Submit':",t.includes("Click Submit"))}else console.log("   ‚ùå Target <ol> not found in contentHtml!")}}g.contentHtml&&(c("üîç DEBUG: Full HTML content being sent to proxy:"),c(g.contentHtml)),c("üîç DEBUG: Full extractedData structure:",e),y.setMessage("Saving to Notion...");const h=await async function(e){if(c("üì§ Sending processed content to proxy for Notion upload"),e.contentHtml||e.content){const t=e.contentHtml||e.content;console.log("üìä PROXY-API.JS - Total HTML length:",t.length);const n=(t.match(/<section[^>]*id="predictive-intelligence-for-incident__section_/g)||[]).length;console.log("üìä PROXY-API.JS - Sections in HTML:",n);const o=(t.match(/class="topic task nested1"/g)||[]).length;console.log("üìä PROXY-API.JS - Number of article.nested1 in HTML:",o);const a=(t.match(/class="[^"]*nested0[^"]*"/g)||[]).length;console.log("üìä PROXY-API.JS - Number of article.nested0 in HTML:",a)}const{overlayModule:t}=await Promise.resolve().then(function(){return x});try{t.setMessage("Converting HTML to Notion blocks..."),console.log("üöÄ PROXY-API.JS - About to call apiCall with processedData"),console.log("üöÄ PROXY-API.JS - processedData.content length:",e.content?.length),console.log("üöÄ PROXY-API.JS - processedData.contentHtml length:",e.contentHtml?.length);const n=await v("POST","/api/W2N",e);if(c("Raw proxy response:",JSON.stringify(n,null,2)),n&&n.success){t.setMessage("‚úì Page created and nested content organized!");let e=n.data?n.data.pageUrl:n.pageUrl;const o=n.data?n.data.page:n.page;if(c("Extracted pageUrl:",e),c("Extracted page:",o),!e&&o&&o.id&&(e=`https://www.notion.so/${o.id.replace(/-/g,"")}`,c("Constructed pageUrl from page.id:",e)),!e)throw c("‚ùå No page URL or page ID returned from proxy - page creation may have failed"),new Error("Page creation failed - no page URL returned");return c("‚úÖ Content uploaded to Notion successfully:",e),n}throw new Error(n?.error||"Failed to upload content")}catch(e){throw c("‚ùå Failed to send content to proxy:",e),e}}(g);if(!h.success)throw new Error(h.error||"Proxy processing failed");{const e=window.ServiceNowToNotion?.autoExtractState?.running;if(!e){try{y.done({success:!0,pageUrl:h.pageUrl||null,autoCloseMs:3e3})}catch(e){try{y.close&&y.close()}catch(e){}}!function(e){D(e?.pageUrl?`‚úÖ Content saved to Notion!\n\nPage: ${e.pageUrl}`:"‚úÖ Content saved to Notion!",5e3)}(h),h.pageUrl&&setTimeout(()=>{confirm("Would you like to open the created Notion page?")&&window.open(h.pageUrl,"_blank")},1e3)}}}catch(e){throw c("‚ùå Proxy processing failed:",e),e}}async findDuplicatePages(e,t){const n=e?.id||e?.database_id;if(!n)return c("Duplicate detection skipped: database id missing"),null;const o=this.getTitlePropertyName(e),a=[],r=new Set,i=(t.title||"").trim();o&&i&&(a.push({property:o,title:{equals:i}}),r.add("Title"));const s=[];Object.entries(t.properties||{}).forEach(([e,t])=>{if(t&&"object"==typeof t&&"string"==typeof t.url&&t.url.trim()){const n=t.url.trim();s.push({property:e,value:n,label:e})}});const l=[],d=new Set;if(s.forEach(e=>{const t=`${e.property}::${e.value}`;d.has(t)||(d.add(t),l.push(e))}),l.forEach(e=>{a.push({property:e.property,url:{equals:e.value}}),r.add(e.label||e.property)}),0===a.length)return c("Duplicate detection skipped: no filters available"),null;const u=1===a.length?a[0]:{or:a};c("üîé Checking for duplicates with filters:",u);const p={filter:u,page_size:5,sorts:[{timestamp:"last_edited_time",direction:"descending"}]},g=await async function(e,t={}){if(!e)throw new Error("Database ID is required for query");try{const n=`/api/databases/${e}/query`,o=await v("POST",n,t);if(o&&o.success)return o;const a=o&&(o.error||o.message)||"Failed to query database";throw new Error(a)}catch(e){throw c("‚ùå Database query failed:",e),e}}(n,p),m=Array.isArray(g?.results)?g.results:[];if(0===m.length)return{duplicates:[],reasonLabels:Array.from(r),titlePropertyName:o};return{duplicates:m.map(e=>{const t=this.extractPageTitle(e,o),n=e?.url||null,a=new Set;return o&&i&&this.areStringsEquivalent(t,i)&&a.add("Title match"),l.forEach(t=>{const n=e?.properties?.[t.property],o=this.extractUrlFromProperty(n);o&&this.areStringsEquivalent(o,t.value)&&a.add(`${t.property} match`)}),{id:e.id,page:{id:e.id,title:t,url:n},reasons:Array.from(a)}}),reasonLabels:Array.from(r),titlePropertyName:o}}getTitlePropertyName(e){const t=e?.properties||{};return Object.keys(t).find(e=>"title"===t[e]?.type)||null}extractPageTitle(e,t){let n=t;if(n||(n=this.getTitlePropertyName({properties:e?.properties||{}})),!n)return"";const o=e?.properties?.[n];return o&&Array.isArray(o.title)?o.title.map(e=>e.plain_text||"").join("").trim():""}extractUrlFromProperty(e){return e&&"object"==typeof e?"string"==typeof e.url?e.url.trim():Array.isArray(e.rich_text)?e.rich_text.map(e=>e.plain_text||"").join("").trim():null:null}areStringsEquivalent(e,t){return!(!e||!t)&&e.trim().toLowerCase()===t.trim().toLowerCase()}createNotionBlocks(e){const t=[];if(e.sections&&e.sections.length>0)e.sections.forEach(e=>{e.title&&t.push({object:"block",type:"heading_2",heading_2:{rich_text:[{type:"text",text:{content:e.title}}]}}),e.content&&t.push({object:"block",type:"paragraph",paragraph:{rich_text:[{type:"text",text:{content:e.content.slice(0,2e3)}}]}})});else if(e.text){e.text.split("\n\n").filter(e=>e.trim()).forEach(e=>{t.push({object:"block",type:"paragraph",paragraph:{rich_text:[{type:"text",text:{content:e.trim().slice(0,2e3)}}]}})})}return t}async showDatabaseSelection(){try{L()}catch(e){c("Failed to show database selection modal:",e)}}showSettingsModal(){try{w()}catch(e){c("Failed to inject/show advanced settings modal:",e)}}showIconCoverModal(){try{C()}catch(e){c("Failed to inject/show icon cover modal:",e)}}}let be=null;window.ServiceNowToNotion={app:()=>be,version:e,debug:c},async function(){try{"loading"===document.readyState&&await new Promise(e=>{document.addEventListener("DOMContentLoaded",e)}),await new Promise(e=>setTimeout(e,2e3)),be=new he,await be.initialize(),c("üéâ ServiceNow-2-Notion application ready!")}catch(e){c("üí• Failed to initialize application:",e),console.error("ServiceNow-2-Notion initialization failed:",e)}}(),window.updateUIFromConfig=function(){try{const e=i(),t=document.getElementById("w2n-selected-database-label"),n=document.getElementById("w2n-indicator-martian");t&&(t.textContent=e.databaseName?`Database: ${e.databaseName}`:"Database: (none)"),n&&(n.textContent=e.useMartian?"Martian: on":"Martian: off")}catch(e){c("Failed to update UI from config:",e)}}}()}();
